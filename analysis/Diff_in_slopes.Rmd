---
title: "Slope_analysis"
author: "Lauren Blake"
date: "November 10, 2016"
output: pdf_document
---

The goal of this analysis is to determine the differences in slopes between the species. For example, we would like to know the difference in the median of the slope between human day 0 to 1 and chimp day 0 to 1.

```{r setup}
# Load libraries

library("plotly")
library("ggplot2")

# Load the data
cpm_norm_data <- read.delim("~/Desktop/Endoderm_TC/ashlar-trial/data/cpm_norm_data.txt")
```

Slope is defined as (y2-y1)/(x2-x1). We will find the slope for each species at several time points:

* Day 0 to Day 1
* Day 1 to Day 2
* Day 2 to Day 3
* Day 0 to Day 3

#### Day 0 to Day 1
```{r day 0 to day 1 humans}
# Find the slope for humans day 0 to day 1. Note: we will not use D0_20157_0116 in this analysis because the day 0 expression data was removed earlier for this sample. 

# Calculate the slope
calc_slope_day01_humans_H1A <- (1-0)/(cpm_norm_data[,16] - cpm_norm_data[,1])
calc_slope_day01_humans_H2A <- (1-0)/(cpm_norm_data[,18] - cpm_norm_data[,2])
calc_slope_day01_humans_H3A <- (1-0)/(cpm_norm_data[,19] - cpm_norm_data[,3])
calc_slope_day01_humans_H4A <- (1-0)/(cpm_norm_data[,20] - cpm_norm_data[,4])
calc_slope_day01_humans_H5A <- (1-0)/(cpm_norm_data[,21] - cpm_norm_data[,5])
calc_slope_day01_humans_H5B <- (1-0)/(cpm_norm_data[,22] - cpm_norm_data[,6])
calc_slope_day01_humans_H6A <- (1-0)/(cpm_norm_data[,23] - cpm_norm_data[,7])

# Bind these together

slope_day01_humans <- cbind(calc_slope_day01_humans_H1A, calc_slope_day01_humans_H2A, calc_slope_day01_humans_H3A, calc_slope_day01_humans_H4A, calc_slope_day01_humans_H5A, calc_slope_day01_humans_H5B, calc_slope_day01_humans_H6A)

# Take the median

med_slope_day01_humans <- as.data.frame(apply(slope_day01_humans, 1, median))
dim(med_slope_day01_humans)

```

```{r day 0 to day 1 chimps}
# Calculate the slope
calc_slope_day01_chimps_C1A <- (1-0)/(cpm_norm_data[,24] - cpm_norm_data[,8])
calc_slope_day01_chimps_C1B <- (1-0)/(cpm_norm_data[,25] - cpm_norm_data[,9])
calc_slope_day01_chimps_C2A <- (1-0)/(cpm_norm_data[,26] - cpm_norm_data[,10])
calc_slope_day01_chimps_C2B <- (1-0)/(cpm_norm_data[,27] - cpm_norm_data[,11])
calc_slope_day01_chimps_C3A <- (1-0)/(cpm_norm_data[,28] - cpm_norm_data[,12])
calc_slope_day01_chimps_C3B <- (1-0)/(cpm_norm_data[,29] - cpm_norm_data[,13])
calc_slope_day01_chimps_C4A <- (1-0)/(cpm_norm_data[,30] - cpm_norm_data[,14])
calc_slope_day01_chimps_C4B <- (1-0)/(cpm_norm_data[,31] - cpm_norm_data[,15])

# Bind these together

slope_day01_chimps <- cbind(calc_slope_day01_chimps_C1A, calc_slope_day01_chimps_C1B, calc_slope_day01_chimps_C2A, calc_slope_day01_chimps_C2B, calc_slope_day01_chimps_C3A, calc_slope_day01_chimps_C3B, calc_slope_day01_chimps_C4A, calc_slope_day01_chimps_C4B)

# Take the median

med_slope_day01_chimps <- as.data.frame(apply(slope_day01_chimps, 1, median))
dim(med_slope_day01_chimps)
```

#### Day 1 to day 2

```{r}
# Calculate the slope
calc_slope_day12_humans_H1A <- (2-1)/(cpm_norm_data[,32] - cpm_norm_data[,16])
calc_slope_day12_humans_H1B <- (2-1)/(cpm_norm_data[,33] - cpm_norm_data[,17])
calc_slope_day12_humans_H2A <- (2-1)/(cpm_norm_data[,34] - cpm_norm_data[,18])
calc_slope_day12_humans_H3A <- (2-1)/(cpm_norm_data[,35] - cpm_norm_data[,19])
calc_slope_day12_humans_H4A <- (2-1)/(cpm_norm_data[,36] - cpm_norm_data[,20])
calc_slope_day12_humans_H5A <- (2-1)/(cpm_norm_data[,37] - cpm_norm_data[,21])
calc_slope_day12_humans_H5B <- (2-1)/(cpm_norm_data[,38] - cpm_norm_data[,22])
calc_slope_day12_humans_H6A <- (2-1)/(cpm_norm_data[,39] - cpm_norm_data[,23])

# Bind these together

slope_day12_humans <- cbind(calc_slope_day12_humans_H1A, calc_slope_day12_humans_H1B, calc_slope_day12_humans_H2A, calc_slope_day12_humans_H3A, calc_slope_day12_humans_H4A, calc_slope_day12_humans_H5A, calc_slope_day12_humans_H5B, calc_slope_day12_humans_H6A)
dim(slope_day12_humans)

# Take the median

med_slope_day12_humans <- as.data.frame(apply(slope_day12_humans, 1, median))
dim(med_slope_day12_humans)
```

```{r}
# Calculate the slope
calc_slope_day12_chimps_C1A <- (2-1)/(cpm_norm_data[,40] - cpm_norm_data[,24])
calc_slope_day12_chimps_C1B <- (2-1)/(cpm_norm_data[,41] - cpm_norm_data[,25])
calc_slope_day12_chimps_C2A <- (2-1)/(cpm_norm_data[,42] - cpm_norm_data[,26])
calc_slope_day12_chimps_C2B <- (2-1)/(cpm_norm_data[,43] - cpm_norm_data[,27])
calc_slope_day12_chimps_C3A <- (2-1)/(cpm_norm_data[,44] - cpm_norm_data[,28])
calc_slope_day12_chimps_C3B <- (2-1)/(cpm_norm_data[,45] - cpm_norm_data[,29])
calc_slope_day12_chimps_C4A <- (2-1)/(cpm_norm_data[,46] - cpm_norm_data[,30])
calc_slope_day12_chimps_C4B <- (2-1)/(cpm_norm_data[,47] - cpm_norm_data[,31])

# Bind these together

slope_day12_chimps <- cbind(calc_slope_day12_chimps_C1A, calc_slope_day12_chimps_C1B, calc_slope_day12_chimps_C2A, calc_slope_day12_chimps_C2B, calc_slope_day12_chimps_C3A, calc_slope_day12_chimps_C3B, calc_slope_day12_chimps_C4A, calc_slope_day12_chimps_C4B)

# Take the median

med_slope_day12_chimps <- as.data.frame(apply(slope_day12_chimps, 1, median))
dim(med_slope_day12_chimps)
```


#### Day 2 to Day 3

```{r}
# Calculate the slope
calc_slope_day23_humans_H1A <- (3-2)/(cpm_norm_data[,48] - cpm_norm_data[,32])
calc_slope_day23_humans_H1B <- (3-2)/(cpm_norm_data[,49] - cpm_norm_data[,33])
calc_slope_day23_humans_H2A <- (3-2)/(cpm_norm_data[,50] - cpm_norm_data[,34])
calc_slope_day23_humans_H3A <- (3-2)/(cpm_norm_data[,51] - cpm_norm_data[,35])
calc_slope_day23_humans_H4A <- (3-2)/(cpm_norm_data[,52] - cpm_norm_data[,36])
calc_slope_day23_humans_H5A <- (3-2)/(cpm_norm_data[,53] - cpm_norm_data[,37])
calc_slope_day23_humans_H5B <- (3-2)/(cpm_norm_data[,54] - cpm_norm_data[,38])
calc_slope_day23_humans_H6A <- (3-2)/(cpm_norm_data[,55] - cpm_norm_data[,39])

# Bind these together

slope_day23_humans <- cbind(calc_slope_day23_humans_H1A, calc_slope_day23_humans_H2A, calc_slope_day23_humans_H3A, calc_slope_day23_humans_H4A, calc_slope_day23_humans_H5A, calc_slope_day23_humans_H5B, calc_slope_day23_humans_H6A)

# Take the median

med_slope_day23_humans <- as.data.frame(apply(slope_day23_humans, 1, median))
dim(med_slope_day23_humans)
```

```{r}
# Calculate the slope
calc_slope_day23_chimps_C1A <- (3-2)/(cpm_norm_data[,56] - cpm_norm_data[,40])
calc_slope_day23_chimps_C1B <- (3-2)/(cpm_norm_data[,57] - cpm_norm_data[,41])
calc_slope_day23_chimps_C2A <- (3-2)/(cpm_norm_data[,58] - cpm_norm_data[,42])
calc_slope_day23_chimps_C2B <- (3-2)/(cpm_norm_data[,59] - cpm_norm_data[,43])
calc_slope_day23_chimps_C3A <- (3-2)/(cpm_norm_data[,60] - cpm_norm_data[,44])
calc_slope_day23_chimps_C3B <- (3-2)/(cpm_norm_data[,61] - cpm_norm_data[,45])
calc_slope_day23_chimps_C4A <- (3-2)/(cpm_norm_data[,62] - cpm_norm_data[,46])
calc_slope_day23_chimps_C4B <- (3-2)/(cpm_norm_data[,63] - cpm_norm_data[,47])

# Bind these together

slope_day23_chimps <- cbind(calc_slope_day23_chimps_C1A, calc_slope_day23_chimps_C1B, calc_slope_day23_chimps_C2A, calc_slope_day23_chimps_C2B, calc_slope_day23_chimps_C3A, calc_slope_day23_chimps_C3B, calc_slope_day23_chimps_C4A, calc_slope_day23_chimps_C4B)

# Take the median

med_slope_day23_chimps <- as.data.frame(apply(slope_day23_chimps, 1, median))
dim(med_slope_day23_chimps)
```

#### Day 0 to Day 3

```{r}

# Calculate the slope
calc_slope_day03_humans_H1A <- (3-0)/(cpm_norm_data[,48] - cpm_norm_data[,1])
calc_slope_day03_humans_H2A <- (3-0)/(cpm_norm_data[,50] - cpm_norm_data[,2])
calc_slope_day03_humans_H3A <- (3-0)/(cpm_norm_data[,51] - cpm_norm_data[,3])
calc_slope_day03_humans_H4A <- (3-0)/(cpm_norm_data[,52] - cpm_norm_data[,4])
calc_slope_day03_humans_H5A <- (3-0)/(cpm_norm_data[,53] - cpm_norm_data[,5])
calc_slope_day03_humans_H5B <- (3-0)/(cpm_norm_data[,54] - cpm_norm_data[,6])
calc_slope_day03_humans_H6A <- (3-0)/(cpm_norm_data[,55] - cpm_norm_data[,7])

# Bind these together

slope_day03_humans <- cbind(calc_slope_day03_humans_H1A, calc_slope_day03_humans_H2A, calc_slope_day03_humans_H3A, calc_slope_day03_humans_H4A, calc_slope_day03_humans_H5A, calc_slope_day03_humans_H5B, calc_slope_day03_humans_H6A)

# Take the median

med_slope_day03_humans <- as.data.frame(apply(slope_day03_humans, 1, median))
dim(med_slope_day03_humans)

```


```{r}
# Calculate the slope
calc_slope_day03_chimps_C1A <- (3-0)/(cpm_norm_data[,56] - cpm_norm_data[,8])
calc_slope_day03_chimps_C1B <- (3-0)/(cpm_norm_data[,57] - cpm_norm_data[,9])
calc_slope_day03_chimps_C2A <- (3-0)/(cpm_norm_data[,58] - cpm_norm_data[,10])
calc_slope_day03_chimps_C2B <- (3-0)/(cpm_norm_data[,59] - cpm_norm_data[,11])
calc_slope_day03_chimps_C3A <- (3-0)/(cpm_norm_data[,60] - cpm_norm_data[,12])
calc_slope_day03_chimps_C3B <- (3-0)/(cpm_norm_data[,61] - cpm_norm_data[,13])
calc_slope_day03_chimps_C4A <- (3-0)/(cpm_norm_data[,62] - cpm_norm_data[,14])
calc_slope_day03_chimps_C4B <- (3-0)/(cpm_norm_data[,63] - cpm_norm_data[,15])

# Bind these together

slope_day03_chimps <- cbind(calc_slope_day03_chimps_C1A, calc_slope_day03_chimps_C1B, calc_slope_day03_chimps_C2A, calc_slope_day03_chimps_C2B, calc_slope_day03_chimps_C3A, calc_slope_day03_chimps_C3B, calc_slope_day03_chimps_C4A, calc_slope_day03_chimps_C4B)

# Take the median

med_slope_day03_chimps <- as.data.frame(apply(slope_day03_chimps, 1, median))
dim(med_slope_day03_chimps)
```

#### Difference of the medians

```{r}
# Find the difference
day01 <- med_slope_day01_humans - med_slope_day01_chimps
colnames(day01) <- c("median")
day12 <- med_slope_day12_humans - med_slope_day12_chimps
colnames(day12) <- c("median")
day23 <- med_slope_day23_humans - med_slope_day23_chimps
colnames(day23) <- c("median")
day03 <- med_slope_day03_humans - med_slope_day03_chimps
colnames(day03) <- c("median")

# Bind together

labels1 <- array("Day 0 to 1", dim = c(10304, 1)) 
labels2 <- array("Day 1 to 2", dim = c(10304, 1)) 
labels3 <- array("Day 2 to 3", dim = c(10304, 1)) 
labels4 <- array("Day 0 to 3", dim = c(10304, 1)) 

labels <- rbind(labels1, labels2, labels3, labels4)

all_days <- rbind(day01, day12, day23, day03)


# label the names of genes

gene_names <- array(rownames(cpm_norm_data), dim = c(10304,1))

gene_names_all_days <- rbind(gene_names, gene_names, gene_names, gene_names) 

# Save this table

write.table(gene_names_all_days,file="~/Desktop/Endoderm_TC/ashlar-trial/data/median_slope_differences.txt",sep="\t", col.names = T, row.names = T)


# Combine days, medians, gene names

boxplot_slopes <- cbind(labels,all_days,gene_names_all_days)
head(boxplot_slopes)

# Make plot

boxplot_slopes$labels <- factor(boxplot_slopes$labels,
    levels = c('Day 0 to 1','Day 1 to 2', 'Day 2 to 3', 'Day 0 to 3'),ordered = TRUE)

ggplot(boxplot_slopes, aes(labels, median)) + geom_boxplot(aes(fill = labels)) + geom_point(aes(text = gene_names_all_days)) + labs(x = "Days included in the slope calculation") + labs(y = "Median slope difference between the two species") + labs(title = "Median slope difference between the two species (4 time point comparisons)") + guides(fill = FALSE)

#+ scale_fill_discrete(name="Days included in \n slope calculation", labels = c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 0 to 3"))
ggplotly()

```

