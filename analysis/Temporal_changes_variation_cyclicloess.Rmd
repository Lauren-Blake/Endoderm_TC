---
title: "Explore_temporal_changes_in_variation"
author: "Lauren Blake"
date: "January 9, 2017"
output: html_document
---

The goal of this script is to assess the extent of regulatory variation in our cell types. 

# Global variance trends 

## Check data

```{r}
# Load libraries

library("ggplot2")
library("qvalue")
source("~/Desktop/Endoderm_TC/ashlar-trial/analysis/chunk-options.R")
library("RColorBrewer")

# Load colors
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))



# Load cyclic loess normalized data

cyclicloess_norm <- read.delim("~/Desktop/Endoderm_TC/ashlar-trial/data/cpm_cyclicloess.txt")

```

## Take the mean of technical replicates for each individual and visualize the data

```{r}
# Take the mean of the technical replicates when available

  # Day 0 technical replicates
D0_28815 <- as.data.frame(apply(cyclicloess_norm[,5:6], 1, mean))
D0_3647 <- as.data.frame(apply(cyclicloess_norm[,8:9], 1, mean))
D0_3649 <- as.data.frame(apply(cyclicloess_norm[,10:11], 1, mean))
D0_40300 <- as.data.frame(apply(cyclicloess_norm[,12:13], 1, mean))
D0_4955 <- as.data.frame(apply(cyclicloess_norm[,14:15], 1, mean))
  # Day 1 technical replicates
D1_20157 <- as.data.frame(apply(cyclicloess_norm[,16:17], 1, mean))
D1_28815 <- as.data.frame(apply(cyclicloess_norm[,21:22], 1, mean))
D1_3647 <- as.data.frame(apply(cyclicloess_norm[,24:25], 1, mean))
D1_3649 <- as.data.frame(apply(cyclicloess_norm[,26:27], 1, mean))
D1_40300 <- as.data.frame(apply(cyclicloess_norm[,28:29], 1, mean))
D1_4955 <- as.data.frame(apply(cyclicloess_norm[,30:31], 1, mean))
  # Day 2 technical replicates
D2_20157 <- as.data.frame(apply(cyclicloess_norm[,32:33], 1, mean))
D2_28815 <- as.data.frame(apply(cyclicloess_norm[,37:38], 1, mean))
D2_3647 <- as.data.frame(apply(cyclicloess_norm[,40:41], 1, mean))
D2_3649 <- as.data.frame(apply(cyclicloess_norm[,42:43], 1, mean))
D2_40300 <- as.data.frame(apply(cyclicloess_norm[,44:45], 1, mean))
D2_4955 <- as.data.frame(apply(cyclicloess_norm[,46:47], 1, mean))
  # Day 3 technical replicates
D3_20157 <- as.data.frame(apply(cyclicloess_norm[,48:49], 1, mean))
D3_28815 <- as.data.frame(apply(cyclicloess_norm[,53:54], 1, mean))
D3_3647 <- as.data.frame(apply(cyclicloess_norm[,56:57], 1, mean))
D3_3649 <- as.data.frame(apply(cyclicloess_norm[,58:59], 1, mean))
D3_40300 <- as.data.frame(apply(cyclicloess_norm[,60:61], 1, mean))
D3_4955 <- as.data.frame(apply(cyclicloess_norm[,62:63], 1, mean))

# Create a new data frame with all of the combined technical replicates
mean_tech_reps <- cbind(cyclicloess_norm[,1:4], D0_28815, cyclicloess_norm[,7], D0_3647, D0_3649, D0_40300, D0_4955, D1_20157, cyclicloess_norm[,18:20], D1_28815, cyclicloess_norm[,23], D1_3647, D1_3649, D1_40300, D1_4955, D2_20157, cyclicloess_norm[,34:36], D2_28815, cyclicloess_norm[,39], D2_3647, D2_3649, D2_40300, D2_4955, D3_20157, cyclicloess_norm[,50:52], D3_28815, cyclicloess_norm[,55], D3_3647, D3_3649, D3_40300, D3_4955)


colnames(mean_tech_reps) <- c("D0_20157", "D0_20961", "D0_21792", "D0_28162", "D0_28815", "D0_29089", "D0_3647", "D0_3649", "D0_40300", "D0_4955", "D1_20157", "D1_20961", "D1_21792", "D1_28162", "D1_28815", "D1_29089", "D1_3647", "D1_3649", "D1_40300", "D1_4955", "D2_20157", "D2_20961", "D2_21792", "D2_28162", "D2_28815", "D2_29089", "D2_3647", "D2_3649", "D2_40300", "D2_4955", "D3_20157", "D3_20961", "D3_21792", "D3_28162", "D3_28815", "D3_29089", "D3_3647", "D3_3649", "D3_40300", "D3_4955")

dim(mean_tech_reps)

#write.table(mean_tech_reps, file="~/Desktop/Endoderm_TC/ashlar-trial/data/cpm_cyclicloess_40.txt",sep="\t", col.names = T, row.names = T) 

# Make a column for which are averaged or not

averaged_status <- c(1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,1,2,2,2,2,2,1,1,1,2,1,2,2,2,2,2,1,1,1,2,1,2,2,2,2)

# Find the technical factors for the biological replicates (no technical replicates)

bio_rep_samplefactors <- read.delim("~/Desktop/Endoderm_TC/ashlar-trial/data/samplefactors-filtered.txt", stringsAsFactors=FALSE)
day <- bio_rep_samplefactors$Day
species <- bio_rep_samplefactors$Species

# Make PCA plots with the factors colored by day

pca_genes <- prcomp(t(mean_tech_reps), scale = T, retx = TRUE, center = TRUE)

matrixpca <- pca_genes$x
pc1 <- matrixpca[,1]
pc2 <- matrixpca[,2]
pc3 <- matrixpca[,3]
pc4 <- matrixpca[,4]
pc5 <- matrixpca[,5]

pcs <- data.frame(pc1, pc2, pc3, pc4, pc5)

summary <- summary(pca_genes)

#dev.off()

ggplot(data=pcs, aes(x=pc1, y=pc2, color=as.factor(day+1), shape=as.factor(averaged_status), size=2)) + geom_point() + xlab(paste("PC1 (",(summary$importance[2,1]*100), "% of variance)")) + ylab(paste("PC2 (",(summary$importance[2,2]*100), "% of variance)")) + theme_minimal() + guides(color = guide_legend(order=1), size = FALSE, shape = guide_legend(order=3)) + scale_color_discrete(name  ="Day", labels = c("0", "1", "2", "3")) +  scale_shape_manual(values = c(5, 7)) + scale_shape_discrete(name  ="Replicate status", labels = c("Single" ,"Averaged")) + labs(title = "PCs 1 and 2 from global normalized expression")

#ggplot(data=pcs, aes(x=pc1, y=pc2, color=as.factor(day+1), shape=as.factor(averaged_status), size=2)) + geom_point() + xlab(paste("PC1 (",(summary$importance[2,1]*100), "% of variance)")) + ylab(paste("PC2 (",(summary$importance[2,2]*100), "% of variance)")) + scale_shape_manual(values = c(5, 8)) + scale_color_discrete(name  ="Day", labels = c("0", "1", "2", "3"))  + labs(title = "PCs 1 and 2 from global normalized gene expression (Averaged bet. technical replicates)")

#ggplotly()


```

## Examine the means and the variances for each day-species pairs

```{r}
# Calculate the variance for each species-time pair

humans_day0_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,1:6]),1, var) )
colnames(humans_day0_var) <- c("Variance") 
chimps_day0_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,7:10]),1, var))
colnames(chimps_day0_var) <- c("Variance") 
humans_day1_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,11:16]),1, var))
colnames(humans_day1_var) <- c("Variance") 
chimps_day1_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,17:20]),1, var))
colnames(chimps_day1_var) <- c("Variance")
humans_day2_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,21:26]),1, var))
colnames(humans_day2_var) <- c("Variance") 
chimps_day2_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,27:30]),1, var))
colnames(chimps_day2_var) <- c("Variance")
humans_day3_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,31:36]),1, var))
colnames(humans_day3_var) <- c("Variance") 
chimps_day3_var <- as.data.frame(apply(as.data.frame(mean_tech_reps[,37:40]),1, var))
colnames(chimps_day3_var) <- c("Variance")

# Calculate the mean for each species-time pair
humans_day0_mean <-  as.data.frame(apply(as.data.frame(mean_tech_reps[,1:6]),1, mean))
colnames(humans_day0_mean) <- c("Mean")
chimps_day0_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,7:10]),1, mean))
colnames(chimps_day0_mean) <- c("Mean")
humans_day1_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,11:16]),1, mean))
colnames(humans_day1_mean) <- c("Mean")
chimps_day1_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,17:20]),1, mean))
colnames(chimps_day1_mean) <- c("Mean")
humans_day2_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,21:26]),1, mean))
colnames(humans_day2_mean) <- c("Mean")
chimps_day2_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,27:30]),1, mean))
colnames(chimps_day2_mean) <- c("Mean")
humans_day3_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,31:36]),1, mean))
colnames(humans_day3_mean) <- c("Mean")
chimps_day3_mean <- as.data.frame(apply(as.data.frame(mean_tech_reps[,37:40]),1, mean))
colnames(chimps_day3_mean) <- c("Mean")

# Make arrays with all the means

labels1 <- array("Chimp Day 0", dim = c(10304, 1)) 
labels2 <- array("Chimp Day 1", dim = c(10304, 1)) 
labels3 <- array("Chimp Day 2", dim = c(10304, 1)) 
labels4 <- array("Chimp Day 3", dim = c(10304, 1)) 
labels5 <- array("Human Day 0", dim = c(10304, 1)) 
labels6 <- array("Human Day 1", dim = c(10304, 1)) 
labels7 <- array("Human Day 2", dim = c(10304, 1)) 
labels8 <- array("Human Day 3", dim = c(10304, 1)) 

# Make species-day labels
labels9 <- rbind(labels1, labels2, labels3, labels4, labels5, labels6, labels7, labels8)
labels <- as.numeric(as.factor(labels9))
# Make labels so same days from different species are the same color
labels10 <- rbind(labels1, labels2, labels3, labels4, labels1, labels2, labels3, labels4)
labels10 <- as.numeric(as.factor(labels10))

#1 Overall trend across genes

# Boxplot of means gives general trend

# Combine means
HC_mean <- rbind(as.data.frame(chimps_day0_mean), as.data.frame(chimps_day1_mean), as.data.frame(chimps_day2_mean), as.data.frame(chimps_day3_mean), as.data.frame(humans_day0_mean), as.data.frame(humans_day1_mean), as.data.frame(humans_day2_mean), as.data.frame(humans_day3_mean))

HC_mean_labels <- cbind(HC_mean, labels, labels10)

m <- ggplot(HC_mean_labels, aes(x = factor(labels), y = HC_mean))
m <- m + geom_violin(aes(fill = factor(labels10)), show.legend = FALSE) + geom_boxplot(aes(fill = factor(labels10)), show.legend = FALSE, outlier.shape = NA,width=0.2) + theme_bw() + scale_y_continuous(trans = "log2") + ggtitle("Mean for each gene by species and day") + xlab("Species-Day Pair") + ylab("Mean for each gene") 
m <- m + scale_x_discrete(labels=c("1" = "C Day 0", "2" = "C Day 1", "3" = "C Day 2", "4" = "C Day 3", "5" = "H Day 0", "6" = "H Day 1", "7" = "H Day 2", "8" = "H Day 3"))
m

# Take log2 of each data frame

log_chimps_day0_var <- log2(chimps_day0_var)
log_chimps_day1_var <- log2(chimps_day1_var)
log_chimps_day2_var <- log2(chimps_day2_var)
log_chimps_day3_var <- log2(chimps_day3_var)
log_humans_day0_var <- log(humans_day0_var)
log_humans_day1_var <- log2(humans_day1_var)
log_humans_day2_var <- log2(humans_day2_var)
log_humans_day3_var <- log2(humans_day3_var)


# Boxplot of variances gives general trend
HC_var <- rbind(as.data.frame(log_chimps_day0_var), as.data.frame(log_chimps_day1_var), as.data.frame(log_chimps_day2_var), as.data.frame(log_chimps_day3_var), as.data.frame(log_humans_day0_var), as.data.frame(log_humans_day1_var), as.data.frame(log_humans_day2_var), as.data.frame(log_humans_day3_var))


# Make a boxplot of log2(variance of gene expression levels)

HC_var_labels <- cbind(HC_var, labels, labels10)

dim(HC_var_labels)


bjp<-
theme(
  
  plot.title = element_text(size = 16, face = "bold"),
  axis.text.y =  element_text(size = 14,face = "bold",color = "black"),
  axis.text.x =  element_text(size = 14,face = "bold",color = "black"),
  axis.title.y = element_text(size = 14,face = "bold"),
  axis.title.x = element_text(size = 14,face = "bold"),
  legend.text = element_text(size = 14,face = "bold"),
  legend.title = element_text(size = 14,face = "bold"),
  strip.text.x = element_text(size = 14,face = "bold"),
  strip.text.y = element_text(size = 14,face = "bold"),
  strip.background = element_rect(colour = "black", size = 2))

p <- ggplot(HC_var_labels, aes(x = factor(labels), y = HC_var))
p <- p + geom_violin(aes(fill = factor(labels10)), show.legend = FALSE) + geom_boxplot(aes(fill = factor(labels10)), show.legend = FALSE, outlier.shape = NA,width=0.2) + theme_bw() + xlab("Species-Day Pair") + ylab("log2 variance of expression for each gene") 
p <- p + scale_x_discrete(labels=c("1" = "C Day 0", "2" = "C Day 1", "3" = "C Day 2", "4" = "C Day 3", "5" = "H Day 0", "6" = "H Day 1", "7" = "H Day 2", "8" = "H Day 3"))
p + bjp



```

# Evaluating global changes in variation 

## No global reduction in means between day 0 and day 1 in both species

Check to see if differences between means (of all gene expression values) within humans and chimps
between days

```{r}

########## Within chimps ##########

# Test at least one of the means is different
group <- rbind(labels1, labels2, labels3, labels4)

mean_day_species <- rbind(chimps_day0_mean,chimps_day1_mean, chimps_day2_mean, chimps_day3_mean)

aov_groups <- cbind(mean_day_species, group)

dim(aov_groups)

aov_bet <- oneway.test(aov_groups$Mean ~ aov_groups$group)
aov_bet

#F = 4.4683, num df = 3, denom df = 22893, p-value = 0.003845F = 3.8146, num df = 3, denom df = 22892, p-value = 0.009564

# Test groups individually

# Day 0 and Day 1
t.test(chimps_day0_mean, chimps_day1_mean) # 0.1716
# Day 1 and Day 2
t.test(chimps_day1_mean, chimps_day2_mean) # 0.2033
# Day 2 and Day 3
t.test(chimps_day2_mean, chimps_day3_mean) # 0.6032


########## Within humans ##########

# Test at least one of the means is different
group <- rbind(labels5, labels6, labels7, labels8)

mean_day_species <- rbind(humans_day0_mean,humans_day1_mean, humans_day2_mean, humans_day3_mean)

aov_groups <- cbind(mean_day_species, group)

dim(aov_groups)

aov_bet <- oneway.test(aov_groups$Mean ~ aov_groups$group)
aov_bet

# F = 5.5523, num df = 3, denom df = 22893, p-value = 0.0008336

# Test groups individually

# Day 0 and Day 1
t.test(humans_day0_mean, humans_day1_mean) # 0.2702
# Day 1 and Day 2
t.test(humans_day1_mean, humans_day2_mean) # 0.02824
# Day 2 and Day 3
t.test(humans_day2_mean, humans_day3_mean) # 0.628

```

Conclusion: For both species, there is at least 1 mean that is different; however, when testing between the humans and chimps day 0 and 1, there is not enough statistical evidence to suggest a difference in the means of the variances. 


## The effect size for the global reduction in variance between day 0 and 1 in chimpanzees is small but larger in humans.

Check to see if differences variances of all of the genes between humans and chimps

```{r}
# Untransformed variances have a range of 0 to infinity. Therefore, we will log transform the variance values so that there is a range of negative infinity to positive infinity. Then we can use a t-test. 


########## Within chimps ##########

t.test(log2((unlist(chimps_day0_var))), log2((unlist(chimps_day1_var))), alternative = c("greater"))

2^(5.036558 - 4.751923)

# t = 10.235, df = 20439, p-value < 2.2e-16

# Is Day 1 to 2 or 2 to 3 greater?

# Day 1 and Day 2
t.test(log2((unlist(chimps_day1_var))), log2((unlist(chimps_day2_var))), alternative = c("greater")) # p-value = 1

# Day 2 and Day 3
t.test(log2((unlist(chimps_day2_var))), log2((unlist(chimps_day3_var))), alternative = c("greater")) # p-value = 1

########## Within humans ##########


# Day 0 and Day 1
t.test(log2((unlist(humans_day0_var))), log2((unlist(humans_day1_var))), alternative = c("greater"))

2^(4.867707-3.636568)

# Day 1 and Day 2
t.test(log2((unlist(humans_day1_var))), log2((unlist(humans_day2_var))), alternative = c("greater")) # p-value = 1

# Day 2 and Day 3
t.test(log2((unlist(humans_day2_var))), log2((unlist(humans_day3_var))), alternative = c("greater")) # p-value = 0.9986

```

Conclusion: For both species, there is at least 1 mean (of the variances) that is different; however, when testing between the chimps day 0 and 1, there is not enough statistical evidence to suggest a difference in the means of the variances in the chimpanzees. Even if you make the argument that biologically we expect a reduction in variance between day 0 an day 1 (due to cannalization, for example) and therefore try a one-sided t-test, the p-value is still not statistically significant. 

# Characterizing variance trends between days tested at the gene level using F tests

We are interested in the genes that experience either an increase or reduction in variance between days in both species. We are going to use a parametric test. 

## General functions for reduction/increase in variance 

```{r}

## Original code for the qqplots provided by Bryce van de Geijn.
#Output:                                                                                                                                  
#adds a set of qq points to an existing graph                                                                                             

addqqplot=function(pvals, always.plot,density, col_designated){
  len = length(pvals)
  res=qqplot(-log10((1:len)/(1+len)),pvals,plot.it=F)
  return(res)
}

#newqqplot creates a new plot with a set of qq points                                                                                     
#Output:                                                                                                                                  
#creates a new qq plot                                                                                                                    

newqqplot=function(pvals, always.plot,density){
  len = length(pvals)
  res=qqplot(-log10((1:len)/(1+len)),pvals,plot.it=F)
}

```

```{r}

# 1A) Reduction in variation. Enrichment in chimps given that the gene was significant in humans

# We need 4 values for each species: day t-1 start and end values and day t start and end values.

find_qqplot_red_chimps <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t, p_val_cutoff){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)
  
  # Test
#  chimp_var_pval <- array(NA, dim = c(10304, 1))

  # for(i in 1:10304){
  #   x <- t(mean_tech_reps[i,7:10])
  #   y <- t(mean_tech_reps[i,17:20])
  #    htest <- var.test(x, y, alternative = c("greater"))
  #   chimp_var_pval[i,1] <- htest$p.value
# }
# hist(chimp_var_pval)
  #   q_chimp_var_adj_pval <- qvalue(chimp_var_pval)
  # length(q_chimp_var_adj_pval[which(q_chimp_var_adj_pval < 0.05) , ])

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

  #   human_var_pval <- array(NA, dim = c(10304, 1))
  # for(i in 1:10304){
  #   x <- t(mean_tech_reps[i,1:6])
  #   y <- t(mean_tech_reps[i,11:16])
  #   htest <- var.test(x, y, alternative = c("greater"))
  #   human_var_pval[i,1] <- htest$p.value
# }
 
# hist(human_var_pval)
#   q_human_var_adj_pval <- qvalue(human_var_pval)$qvalues
#  length(q_human_var_adj_pval[which(q_human_var_adj_pval < 0.05) , ])
# 3498
  
############ Find p-values of the F_statistics

# Make one data frame for corrected pvalues
  
#  chimp_var_adj_pval <- qvalue(chimp_var_pval)
#  human_var_adj_pval <- qvalue(human_var_pval)$qvalues
#  human_var_pval_adj_pval <- as.data.frame(cbind(human_var_pval, human_var_adj_pval))
#  human_var_pval_adj_pval_order <- human_var_pval_adj_pval[order(human_var_pval_adj_pval[,2]),]
  
# Set p-value  (for FDR)
#  p_val <- human_var_pval_adj_pval_order[max(which(human_var_pval_adj_pval_order[,2] < 0.05)), 1] 

  p_val <- p_val_cutoff
  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)
  
  
  
# Make one data frame for uncorrected pvalues

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Set p-value

#  p_val <- 0.05

# P-val < 0.05 for chimps only
  num_var_pval_chimps <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_humans <- var_pval[ which(var_pval[,2] < p_val), ]
  
# A data frame with the # of genes with significant p-values  
  sig_p_val <- as.data.frame(rbind(dim(num_var_pval_chimps), dim(num_var_pval_humans)))[,1]
  
# Run for the chimps
  num_var_pval_chimps_neg_log <- -log10(var_pval[,1])

  res_chimp <- newqqplot(num_var_pval_chimps_neg_log, -1, 100)

# Run for the shared
  # Find the p-values of the chimps given that it was significant in the humans

  subset_var <- as.data.frame(var_pval[ which(var_pval[,2] < p_val), 1:2])
  num_var_pval_chimp_given_human_no_df <- subset_var[,1]
  num_var_pval_chimp_given_human <- as.data.frame(subset_var[,1])
 
  num_var_pval_shared_neg_log <- -log10(num_var_pval_chimp_given_human)

  res_shared <- addqqplot(num_var_pval_shared_neg_log[,1], -1, 100, pal[3])

  # Information for plotting

  list_values = list(chimp_var_pval, num_var_pval_chimp_given_human_no_df, sig_p_val, res_chimp$x, res_chimp$y, res_shared$x, res_shared$y, max(res_chimp$x), max(res_chimp$y),  max(res_shared$x),  max(res_shared$y))
  
  
  return(list_values)

}

# 2A) Increase in variation. Enrichment in chimps given that the gene was significant in humans

# We need 4 values for each species: day t-1 start and end values and day t start and end values.

find_qqplot_inc_chimps <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t, p_val_cutoff){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Set p-value

  p_val <- p_val_cutoff

# P-val < 0.05 for chimps only
  num_var_pval_chimps <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_humans <- var_pval[ which(var_pval[,2] < p_val), ]
  
# A data frame with the # of genes with significant p-values  
  sig_p_val <- as.data.frame(rbind(dim(num_var_pval_chimps), dim(num_var_pval_humans)))[,1]
  
# Run for the chimps
  num_var_pval_chimps_neg_log <- -log10(var_pval[,1])

  res_chimp <- newqqplot(num_var_pval_chimps_neg_log, -1, 100)

# Run for the shared
  # Find the p-values of the chimps given that it was significant in the humans

  subset_var <- as.data.frame(var_pval[ which(var_pval[,2] < p_val), 1:2])
  num_var_pval_chimp_given_human_no_df <- subset_var[,1]
  num_var_pval_chimp_given_human <- as.data.frame(subset_var[,1])
 
  num_var_pval_shared_neg_log <- -log10(num_var_pval_chimp_given_human)

  res_shared <- addqqplot(num_var_pval_shared_neg_log[,1], -1, 100, pal[3])

  # Information for plotting

  list_values = list(chimp_var_pval, num_var_pval_chimp_given_human_no_df, sig_p_val, res_chimp$x, res_chimp$y, res_shared$x, res_shared$y, max(res_chimp$x), max(res_chimp$y),  max(res_shared$x),  max(res_shared$y))
  
  
  return(list_values)

}

# 1B) Reduction in variation. Enrichment in humans given that the gene was significant in chimps

# We need 4 values for each species: day t-1 start and end values and day t start and end values.

find_qqplot_red_humans <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t, p_val_cutoff){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Set p-value

  p_val <- p_val_cutoff

# P-val < 0.05 for chimps only
  num_var_pval_chimps <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_humans <- var_pval[ which(var_pval[,2] < p_val), ]
  
# A data frame with the # of genes with significant p-values  
  sig_p_val <- as.data.frame(rbind(dim(num_var_pval_chimps), dim(num_var_pval_humans)))[,1]
  
# Run for the humans
  num_var_pval_chimps_neg_log <- -log10(var_pval[,2])

  res_chimp <- newqqplot(num_var_pval_chimps_neg_log, -1, 100)

# Run for the shared
  # Find the p-values of the humans given that it was significant in the chimps

  subset_var <- as.data.frame(var_pval[ which(var_pval[,1] < p_val), 1:2])
  num_var_pval_human_given_chimp_no_df <- subset_var[,2]
  num_var_pval_human_given_chimp <- as.data.frame(subset_var[,2])
 
  num_var_pval_shared_neg_log <- -log10(num_var_pval_human_given_chimp)

  res_shared <- addqqplot(num_var_pval_shared_neg_log[,1], -1, 100, pal[3])

  # Information for plotting

  list_values = list(human_var_pval, num_var_pval_human_given_chimp_no_df, sig_p_val, res_chimp$x, res_chimp$y, res_shared$x, res_shared$y, max(res_chimp$x), max(res_chimp$y),  max(res_shared$x),  max(res_shared$y))
  
  
  return(list_values)

}

# 2B) Increase in variation. Enrichment in humans given that the gene was significant in chimps

# We need 4 values for each species: day t-1 start and end values and day t start and end values.

find_qqplot_inc_humans <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t, p_val_cutoff){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Set p-value

  p_val <- p_val_cutoff

# P-val < 0.05 for chimps only
  num_var_pval_chimps <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_humans <- var_pval[ which(var_pval[,2] < p_val), ]
  
# A data frame with the # of genes with significant p-values  
  sig_p_val <- as.data.frame(rbind(dim(num_var_pval_chimps), dim(num_var_pval_humans)))[,1]
  
# Run for the humans
  num_var_pval_chimps_neg_log <- -log10(var_pval[,2])

  res_chimp <- newqqplot(num_var_pval_chimps_neg_log, -1, 100)

# Run for the shared
  # Find the p-values of the humans given that it was significant in the chimps

  subset_var <- as.data.frame(var_pval[ which(var_pval[,1] < p_val), 1:2])
  num_var_pval_human_given_chimp_no_df <- subset_var[,2]
  num_var_pval_human_given_chimp <- as.data.frame(subset_var[,2])
 
  num_var_pval_shared_neg_log <- -log10(num_var_pval_human_given_chimp)

  res_shared <- addqqplot(num_var_pval_shared_neg_log[,1], -1, 100, pal[3])

  # Information for plotting

  list_values = list(human_var_pval, num_var_pval_human_given_chimp_no_df, sig_p_val, res_chimp$x, res_chimp$y, res_shared$x, res_shared$y, max(res_chimp$x), max(res_chimp$y),  max(res_shared$x),  max(res_shared$y))
  
  
  return(list_values)

}

# Make multiple ggplots on the same page

# Multiplot function (from http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_%28ggplot2%29/)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}


```


## Number of significant genes and Storey's pi_0 values for a reduction in variation between days (main paper) 

### Chimpanzees

#### Testing chimps reduction in variance from days 0 to 1

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,7:10])
     y <- t(mean_tech_reps[i,17:20])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_red01 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval)

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 0 to 1"))

# Obtain Storey's pi_0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

# Make a histogram of the p-value distribution

scaleFUN <- function(x) sprintf("%.1f", x)

p1 <- ggplot(chimp_var_pval_red01, aes(chimp_var_pval_red01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.74")', parse=TRUE, x=0.8, y=(1.25), size = 6, colour = "#E77642")
             
            

p1

p1s <- ggplot(chimp_var_pval_red01, aes(chimp_var_pval_red01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.73")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p1s

```

#### Testing chimps reduction in variance from days 1 to 2

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,17:20])
     y <- t(mean_tech_reps[i,27:30])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_red12 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval)

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 1 to 2"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

# Make a histogram of the p-value distribution

p2 <- ggplot(chimp_var_pval_red12, aes(chimp_var_pval_red12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) + geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + ggtitle("Days 1 to 2") + theme(plot.title = element_text(face = "bold")) + annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#E77642")
             
p2

p2s <- ggplot(chimp_var_pval_red12, aes(chimp_var_pval_red12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + ggtitle("Days 1 to 2")  + theme(plot.title = element_text(face = "bold")) + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#E77642")
             
p2s

```

#### Testing chimps reduction in variance from days 2 to 3

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,27:30])
     y <- t(mean_tech_reps[i,37:40])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_red23 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval, breaks = 500, main = c("Chimpanzees days 2 to 3"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p3 <- ggplot(chimp_var_pval_red23, aes(chimp_var_pval_red23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) + labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.94")', parse=TRUE, x=0.2, y=(1.25), size = 6, colour = "#E77642")
             
p3


p3s <- ggplot(chimp_var_pval_red23, aes(chimp_var_pval_red23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.90")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#E77642")
             
p3s
```

#### Testing chimps reduction in variance from days 1 to 3

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,17:20])
     y <- t(mean_tech_reps[i,37:40])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_red13 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval, main = c("Chimpanzees days 1 to 3"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 1 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p3_13 <- ggplot(chimp_var_pval_red13, aes(chimp_var_pval_red13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#E77642")
             
p3_13


p3_13s <- ggplot(chimp_var_pval_red13, aes(chimp_var_pval_red13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#E77642")
             
p3_13s
```


#### Testing humans reduction in variance from days 0 to 1

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,1:6])
     y <- t(mean_tech_reps[i,11:16])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
   }
human_var_pval_red01 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 0 to 1"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p4 <- ggplot(human_var_pval_red01, aes(human_var_pval_red01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.23")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p4

p4s <- ggplot(human_var_pval_red01, aes(human_var_pval_red01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.17")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p4s
```


#### Testing humans reduction in variance from days 1 to 2

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,11:16])
     y <- t(mean_tech_reps[i,21:26])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_red12 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 1 to 2"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 1 to 2"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p5 <- ggplot(human_var_pval_red12, aes(human_var_pval_red12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 1 to 2") + theme(plot.title = element_text(face = "bold")) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.20, y=(2), size = 6, colour = "#00A4F4")
             
p5

p5s <- ggplot(human_var_pval_red12, aes(human_var_pval_red12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 1 to 2") + theme(plot.title = element_text(face = "bold")) + scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.20, y=(2), size = 6, colour = "#00A4F4")
             
p5s
```


#### Testing humans reduction in variance from days 2 to 3

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,21:26])
     y <- t(mean_tech_reps[i,31:36])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_red23 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p6 <- ggplot(human_var_pval_red23, aes(human_var_pval_red23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) + scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.95")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#00A4F4")
             
p6

p6s <- ggplot(human_var_pval_red23, aes(human_var_pval_red23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() +  ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.87")', parse=TRUE, x=0.20, y=(1.25), size = 6, colour = "#00A4F4")
             
p6s

```

#### Testing humans reduction in variance from days 1 to 3

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,11:16])
     y <- t(mean_tech_reps[i,31:36])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_red13 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)


p6_13 <- ggplot(human_var_pval_red13, aes(human_var_pval_red13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +  scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.20, y=(2), size = 6, colour = "#00A4F4") 
             
p6_13

p6_13s <- ggplot(human_var_pval_red13, aes(human_var_pval_red13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density")  + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.20, y=(2), size = 6, colour = "#00A4F4")
             
p6_13s
```

#### Plot reduction in variation (pi_0 determined by a bootstrap method)
```{r}
# Chimps on the top; humans on the bottom
multiplot(p1,p4,p2,p5,p3,p6,p3_13, p6_13, cols=4)

# Chimps on the left, humans on the right
#multiplot(p1,p2,p3,p3_13,p4,p5,p6, p6_13, cols=2)
```

#### Plot reduction in variation (pi_0 determined by a smoother method)
```{r}
# Chimps on the top; humans on the bottom
multiplot(p1s,p4s,p2s,p5s,p3s,p6s,p3_13s, p6_13s, cols=4)

# Chimps on the left, humans on the right
#multiplot(p1s,p2s,p3s,p3_13s,p4s,p5s,p6s, p6_13s, cols=2)
```

## Number of significant genes and Storey's pi_0 values for an increase in variation between days (main paper) 

### Chimpanzees

#### Testing chimps increase in variance from days 0 to 1

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,7:10])
     y <- t(mean_tech_reps[i,17:20])
      htest <- var.test(x, y, alternative = c("less"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_inc01 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval)

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 0 to 1"))

# Obtain Storey's pi_0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

# Make a histogram of the p-value distribution

p1_inc <- ggplot(chimp_var_pval_inc01, aes(chimp_var_pval_inc01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) + 
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.16, y=(1.25), size = 6, colour = "#E77642")
             
            

p1_inc

p1s_inc <- ggplot(chimp_var_pval_inc01, aes(chimp_var_pval_inc01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="1")', parse=TRUE, x=0.16, y=(1.25), size = 6, colour = "#E77642")
             
p1s_inc

```

#### Testing chimps increase in variance from days 1 to 2

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,17:20])
     y <- t(mean_tech_reps[i,27:30])
      htest <- var.test(x, y, alternative = c("less"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_inc12 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval)

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 1 to 2"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

# Make a histogram of the p-value distribution

p2_inc <- ggplot(chimp_var_pval_inc12, aes(chimp_var_pval_inc12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + ggtitle("Days 1 to 2") + theme(plot.title = element_text(face = "bold")) + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.57")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p2_inc

p2s_inc <- ggplot(chimp_var_pval_inc12, aes(chimp_var_pval_inc12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + ggtitle("Days 1 to 2") + theme(plot.title = element_text(face = "bold")) + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.52")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p2s_inc

```

#### Testing chimps increase in variance from days 2 to 3

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,27:30])
     y <- t(mean_tech_reps[i,37:40])
      htest <- var.test(x, y, alternative = c("less"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_inc23 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval, breaks = 500, main = c("Chimpanzees days 2 to 3"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p3_inc <- ggplot(chimp_var_pval_inc23, aes(chimp_var_pval_inc23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) + labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.46")', parse=TRUE, x=0.8, y=(1.25), size = 6, colour = "#E77642")
             
p3_inc


p3s_inc <- ggplot(chimp_var_pval_inc23, aes(chimp_var_pval_inc23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.37")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p3s_inc
```

#### Testing chimps increase in variance from days 1 to 3

```{r}
chimp_var_pval <- array(NA, dim = c(10304, 1))
for(i in 1:10304){
     x <- t(mean_tech_reps[i,17:20])
     y <- t(mean_tech_reps[i,37:40])
      htest <- var.test(x, y, alternative = c("less"))
     chimp_var_pval[i,1] <- htest$p.value
 }

chimp_var_pval_inc13 <- as.data.frame(chimp_var_pval)

# Make a histogram of the unadjusted p-values
hist(chimp_var_pval, main = c("Chimpanzees days 1 to 3"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(chimp_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

which(fdr_adj < 0.05)

# Plot the unadjusted versus adjusted p-values

plot(chimp_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Chimp samples Day 1 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=chimp_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=chimp_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(chimp_var_pval < 0.05))*(1-qvalue(p=chimp_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p3_13_inc <- ggplot(chimp_var_pval_inc13, aes(chimp_var_pval_inc13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.55")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p3_13_inc


p3_13s_inc <- ggplot(chimp_var_pval_inc13, aes(chimp_var_pval_inc13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) + ggtitle("Days 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#E77642") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", chimp"])=="0.51")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#E77642")
             
p3_13s_inc
```


#### Testing humans increase in variance from days 0 to 1

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,1:6])
     y <- t(mean_tech_reps[i,11:16])
     htest <- var.test(x, y, alternative = c("less"))
     human_var_pval[i,1] <- htest$p.value
   }
human_var_pval_inc01 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 0 to 1"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p4_inc <- ggplot(human_var_pval_inc01, aes(human_var_pval_inc01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.16, y=(2), size = 6, colour = "#00A4F4")
             
p4_inc

p4s_inc <- ggplot(human_var_pval_inc01, aes(human_var_pval_inc01[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="1")', parse=TRUE, x=0.16, y=(2), size = 6, colour = "#00A4F4")
             
p4s_inc
```


#### Testing humans increase in variance from days 1 to 2

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,11:16])
     y <- t(mean_tech_reps[i,21:26])
     htest <- var.test(x, y, alternative = c("less"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_inc12 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 1 to 2"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 1 to 2"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p5_inc <- ggplot(human_var_pval_inc12, aes(human_var_pval_inc12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.27")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p5_inc

p5s_inc <- ggplot(human_var_pval_inc12, aes(human_var_pval_inc12[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.21")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p5s_inc
```


#### Testing humans increase in variance from days 2 to 3

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,21:26])
     y <- t(mean_tech_reps[i,31:36])
     htest <- var.test(x, y, alternative = c("less"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_inc23 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p6_inc <- ggplot(human_var_pval_inc23, aes(human_var_pval_inc23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.86")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#00A4F4")
             
p6_inc

p6s_inc <- ggplot(human_var_pval_inc23, aes(human_var_pval_inc23[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.85")', parse=TRUE, x=0.80, y=(1.25), size = 6, colour = "#00A4F4") 
             
p6s_inc

```

#### Testing humans increase in variance from days 1 to 3

```{r}
human_var_pval <- array(NA, dim = c(10304, 1))
   for(i in 1:10304){
     x <- t(mean_tech_reps[i,11:16])
     y <- t(mean_tech_reps[i,31:36])
     htest <- var.test(x, y, alternative = c("less"))
     human_var_pval[i,1] <- htest$p.value
   }

human_var_pval_inc13 <- as.data.frame(human_var_pval)

# Make a histogram of the unadjusted p-values
hist(human_var_pval, main = c("Humans days 0 to 1"))

# Go from unadjusted to B.H. adjusted p-values
fdr_adj <- p.adjust(human_var_pval, method = c("fdr") )

summary(fdr_adj)

# How many B.H. adjusted p-values < 0.05?

length(which(fdr_adj < 0.05))

# Plot the unadjusted versus adjusted p-values

plot(human_var_pval, fdr_adj, xlim = c(0,1), ylim = c(0,1), xlab = c("p-value of the F-test"), ylab = c("BH-adj p-value"), main = c("F test results from Human samples Day 2 to 3"))

# Obtain Storey's pi_0

boot_pi0 <- qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

boot_pi0s <- qvalue(p=human_var_pval, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Obtain pi_1 based on Storey's pi_0

1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0

1-qvalue(p=human_var_pval,  pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

length(which(human_var_pval < 0.05))*(1-qvalue(p=human_var_pval, pi0.method="bootstrap", fdr.level=NULL, robust=TRUE)$pi0)

p6_13_inc <- ggplot(human_var_pval_inc13, aes(human_var_pval_inc13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + geom_hline(yintercept = boot_pi0, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.24")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p6_13_inc

p6_13s_inc <- ggplot(human_var_pval_inc13, aes(human_var_pval_inc13[,1])) + geom_histogram(aes(y = ..density..), fill="white", colour="black", breaks=seq(0, 1, by = 0.02)) + theme_bw() + 
  scale_x_continuous(limits = c(0,1)) +  labs(x = "Unadjusted p-values") + labs(y = "Density")  + geom_hline(yintercept = boot_pi0s, size=2.5, colour = "#00A4F4") + scale_y_continuous(labels=scaleFUN) +
  annotate("text", label='bold(bolditalic(hat(pi)[0][", human"])=="0.20")', parse=TRUE, x=0.80, y=(2), size = 6, colour = "#00A4F4")
             
p6_13s_inc
```

#### Plot reduction in variation (pi_0 determined by a bootstrap method)
```{r}
# Chimps on the top; humans on the bottom
multiplot(p1_inc,p4_inc,p2_inc,p5_inc,p3_inc,p6_inc,p3_13_inc, p6_13_inc, cols=4)

# Chimps on the left, humans on the right
#multiplot(p1,p2,p3,p3_13,p4,p5,p6, p6_13, cols=2)
```

#### Plot reduction in variation (pi_0 determined by a smoother method)
```{r}
# Chimps on the top; humans on the bottom
multiplot(p1s_inc,p4s_inc,p2s_inc,p5s_inc,p3s_inc,p6s_inc,p3_13s_inc, p6_13s_inc, cols=4)

# Chimps on the left, humans on the right
#multiplot(p1s,p2s,p3s,p3_13s,p4s,p5s,p6s, p6_13s, cols=2)
```

## The pairwise changes in variance were robust with respect to p-value cutoff 

### Changes in variance in chimp samples (p-value cutoff 0.05)

```{r}
# Reduction in variance from day 0 to day 1 chimps

qqplot_red_day01 <- find_qqplot_red_chimps(7,10,17,20,1,6,11,16, 0.05)

# Reduction in variance from day 1 to day 2 chimps

qqplot_red_day12 <- find_qqplot_red_chimps(17,20,27,30,11,16,21,26, 0.05)

# Reduction in variance from day 2 to day 3 chimps

qqplot_red_day23 <- find_qqplot_red_chimps(27,30,37,40,21,26,31,36, 0.05)

# Reduction in variance from day 0 to day 2 chimps

qqplot_red_day02 <- find_qqplot_red_chimps(7,10,27,30,1,6,21,26, 0.05)

# Reduction in variance from day 1 to day 3 chimps

qqplot_red_day13 <- find_qqplot_red_chimps(17,20,37,40,11,16,31,36, 0.05)

# Inc. in variance from day 0 to day 1

qqplot_inc_day01 <- find_qqplot_inc_chimps(7,10,17,20,1,6,11,16, 0.05)

# Inc. in variance from day 1 to day 2

qqplot_inc_day12 <- find_qqplot_inc_chimps(17,20,27,30,11,16,21,26, 0.05)

# Inc. in variance from day 2 to day 3

qqplot_inc_day23 <- find_qqplot_inc_chimps(27,30,37,40,21,26,31,36, 0.05)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_chimps(7,10,27,30,1,6,21,26, 0.05)

# Inc. in variance from day 1 to day 3

qqplot_inc_day13 <- find_qqplot_inc_chimps(17,20,37,40,11,16,31,36, 0.05)

# Reduction of variance qqplots- chimps

par(mfrow=c(2,4),oma = c(2, 2, 2, 2))

# Reduction of variance to day 0 to 1 chimps
plot(qqplot_red_day01[[4]],qqplot_red_day01[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 0 to 1")
abline(0,1, col = "black")

# Add to the plot
points(qqplot_red_day01[[6]],qqplot_red_day01[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 1 to 2
plot(qqplot_red_day12[[4]],qqplot_red_day12[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 1 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day12[[6]],qqplot_red_day12[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 2 to 3
plot(qqplot_red_day23[[4]],qqplot_red_day23[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 2 to 3")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day23[[6]],qqplot_red_day23[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 0 to 2
plot(qqplot_red_day02[[4]],qqplot_red_day02[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 0 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day02[[6]],qqplot_red_day02[[7]], pch = 16, col = pal[3])

# Add bottom title

mtext("Reduction in Variation", font = 2, side = 3, line = -1.5, outer = TRUE)

### Increase in variance

# Inc variance to day 0 to 1
plot(qqplot_inc_day01[[4]],qqplot_inc_day01[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 0 to 1")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day01[[6]],qqplot_inc_day01[[7]], pch = 16, col = pal[3])

# Increase of variance to day 1 to 2
plot(qqplot_inc_day12[[4]],qqplot_inc_day12[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 1 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day12[[6]],qqplot_inc_day12[[7]], pch = 16, col = pal[3])


# Increase of variance to day 2 to 3
plot(qqplot_inc_day23[[4]],qqplot_inc_day23[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 2 to 3")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day23[[6]],qqplot_inc_day23[[7]], pch = 16, col = pal[3])

# Increase of variance to day 0 to 2
plot(qqplot_inc_day02[[4]],qqplot_inc_day02[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 0 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day02[[6]],qqplot_inc_day02[[7]], pch = 16, col = pal[3])


mtext("Increase in Variation", font = 2, side = 3, line = -29, outer = TRUE)

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottomright", c("Chimpanzee", "Chimpanzee|significant in humans"), xpd = TRUE, horiz = TRUE, inset = c(0,  0), bty = "n", pch = c(16, 16), col = pal[2:3], cex = 1.5)

#legend("top", c("Chimpanzee", "Chimpanzee|significant in humans"), xpd = TRUE, horiz = TRUE, inset = c(0,  0), bty = "n", pch = c(16, 16), col = pal[2:3], cex = 0.7)
```


### Estimates of pi0 and pi1 for reduction of variation in chimps conditioned on significance in humans (p = 0.05)

```{r}
library("qvalue")
################ REDUCTION IN VARIATION FOR CHIMPS (p = 0.05) ################

# Day 0 to 1


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day01[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +  scale_y_continuous(labels=scaleFUN) +     
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.73")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.55")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p1_05

   

# Day 1 to 2


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day12[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p2_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.5, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.25")', parse=TRUE, x=0.5, y=(pi0est_chimps_given_humans+0.07), size = 6)

p2_05

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.9")', parse=TRUE, x=0.8, y=(pi0est_chimps-0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.8, y=(pi0est_chimps_given_humans+0.07), size = 6)

p3_05

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "black") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.2), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p4_05

```

### Estimates of pi0 and pi1 for increase of variation in chimps conditioned on significance in humans (p = 0.05)

```{r}
############### Increase in Variation ############

# Day 0 to 1

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day01[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.3), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.15), size = 6)

p1_inc_05

# Day 1 to 2

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day12[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p2_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.52")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.34")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p2_inc_05

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) + scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.37")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.24")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.06), size = 6)

p3_inc_05

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.51")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.08), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.39")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans-0.08), size = 6)

p4_inc_05
```


### Changes of variation in humans

```{r}
# Reduction in variance from day 0 to day 1 humans

qqplot_red_day01 <- find_qqplot_red_humans(7,10,17,20,1,6,11,16, 0.05)

# Reduction in variance from day 1 to day 2 humans

qqplot_red_day12 <- find_qqplot_red_humans(17,20,27,30,11,16,21,26,0.05)

# Reduction in variance from day 2 to day 3 humans

qqplot_red_day23 <- find_qqplot_red_humans(27,30,37,40,21,26,31,36,0.05)

# Reduction in variance from day 1 to day 3 humans

qqplot_red_day13 <- find_qqplot_red_humans(17,20,37,40,11,16,31,36,0.05)

# Reduction in variance from day 0 to day 2 humans

qqplot_red_day02 <- find_qqplot_red_humans(7,10,27,30,1,6,21,26,0.05)

# Inc. in variance from day 0 to day 1 humans

qqplot_inc_day01 <- find_qqplot_inc_humans(7,10,17,20,1,6,11,16,0.05)

# Inc. in variance from day 1 to day 2 humans

qqplot_inc_day12 <- find_qqplot_inc_humans(17,20,27,30,11,16,21,26,0.05)

# Inc. in variance from day 2 to day 3 humans

qqplot_inc_day23 <- find_qqplot_inc_humans(27,30,37,40,21,26,31,36,0.05)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_humans(7,10,27,30,1,6,21,26,0.05)

# Inc. in variance from day 1 to day 3 humans

qqplot_inc_day13 <- find_qqplot_inc_humans(17,20,37,40,11,16,31,36,0.05)


# Reduction of variance qqplots- humans

dev.off()

par(mfrow=c(2,4),oma = c(2, 2, 2, 2))

# Reduction of variance to day 0 to 1 humans
plot(qqplot_red_day01[[4]],qqplot_red_day01[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 0 to 1")
abline(0,1, col = "black")

# Add to the plot
points(qqplot_red_day01[[6]],qqplot_red_day01[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 1 to 2
plot(qqplot_red_day12[[4]],qqplot_red_day12[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 1 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day12[[6]],qqplot_red_day12[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 2 to 3
plot(qqplot_red_day23[[4]],qqplot_red_day23[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 2 to 3")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day23[[6]],qqplot_red_day23[[7]], pch = 16, col = pal[3])

# Reduction of variance to day 0 to 2
plot(qqplot_red_day02[[4]],qqplot_red_day02[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved", main = "Day 0 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_red_day02[[6]],qqplot_red_day02[[7]], pch = 16, col = pal[3])

# Add bottom title

mtext("Reduction in Variation", font = 2, side = 3, line = -1.5, outer = TRUE)

### Increase in variance

# Inc variance to day 0 to 1
plot(qqplot_inc_day01[[4]],qqplot_inc_day01[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 0 to 1")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day01[[6]],qqplot_inc_day01[[7]], pch = 16, col = pal[3])

# Increase of variance to day 1 to 2
plot(qqplot_inc_day12[[4]],qqplot_inc_day12[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 1 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day12[[6]],qqplot_inc_day12[[7]], pch = 16, col = pal[3])


# Increase of variance to day 2 to 3
plot(qqplot_inc_day23[[4]],qqplot_inc_day23[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 2 to 3")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day23[[6]],qqplot_inc_day23[[7]], pch = 16, col = pal[3])

# Increase of variance to day 0 to 2
plot(qqplot_inc_day02[[4]],qqplot_inc_day02[[5]], pch = 16, xlim = c(0,6), ylim = c(0,6), col = pal[2], xlab = "-log10(p) Expected", ylab = "-log10(p) Obeserved",  main = "Day 0 to 2")
abline(0,1, col = "black")


# Add to the plot
points(qqplot_inc_day02[[6]],qqplot_inc_day02[[7]], pch = 16, col = pal[3])


mtext("Increase in Variation", font = 2, side = 3, line = -29, outer = TRUE)

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottomright", c("Human", "Human|significant in chimpanzee"), xpd = TRUE, horiz = TRUE, inset = c(0,  0), bty = "n", pch = c(16, 16), col = pal[2:3], cex = 1.5)

#legend("top", c("Human", "Human|significant in chimpanzee"), xpd = TRUE, horiz = TRUE, inset = c(0,  0), bty = "n", pch = c(16, 16), col = pal[2:3], cex = 0.7)


```

### Estimates of pi0 and pi1 for reduction of variation in humans conditioned on significance in chimps (p = 0.05)

```{r}

####################### REDUCTION OF VARIATION IN HUMANS (p = 0.05)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.17")', parse=TRUE, x=0.2, y=(pi0est_humans+0.32), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.16")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_05


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p6_05

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.87")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.81")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.3), size = 6)

p7_05


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.30), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.12), size = 6)

p8_05

multiplot(p1_05,p5_05,p2_05,p6_05,p3_05,p7_05,p4_05,p8_05,cols=4)

```

### Estimates of pi0 and pi1 for increase of variation in humans conditioned on significance in chimps (p = 0.05)

```{r}
####################### INCREASE IN VARIATION IN HUMANS (p = 0.05)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +  scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.32), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_inc_05


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +  scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.21")', parse=TRUE, x=0.2, y=(pi0est_humans+0.32), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.09")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.27), size = 6)

p6_inc_05

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +  scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.85")', parse=TRUE, x=0.25, y=(pi0est_humans+0.05), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.95")', parse=TRUE, x=0.25, y=(pi0est_humans_given_chimps+0.07), size = 6)

p7_inc_05


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_inc_05 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +  scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + labs(x = "Unadjusted p-values") + labs(y = "Density") +  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.20")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.18")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.16), size = 6)

p8_inc_05

multiplot(p1_inc_05,p5_inc_05,p2_inc_05,p6_inc_05,p3_inc_05,p7_inc_05,p4_inc_05,p8_inc_05,cols=4)

```

## Permutation tests

### Permutation test to find the null hypothesis of sharing (reduction in chimps | significant in humans for day 0 to 1 with p-value cutoff of 0.05) 

```{r}
### library

library("picante")

### Make a matrix of the p-values ###

  # Chimp p-values
chimp_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
     x <- t(mean_tech_reps[i,7:10])
     y <- t(mean_tech_reps[i,17:20])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value

}

  # Human p-values

human_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
     x <- t(mean_tech_reps[i,1:6])
     y <- t(mean_tech_reps[i,11:16])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
 }
 

### Matrix for the permuation values

shared_p0_given_permutation <- array(NA, dim = c(100000, 1))
  
### Randomize chimp p-values ###  

for(i in 1:100000){
out_p_val <- randomizeMatrix(chimp_var_pval, null.model = "frequency",iterations = 1000)

var_pval <- as.data.frame(cbind(out_p_val, human_var_pval))
rownames(var_pval) <- rownames(mean_tech_reps)
colnames(var_pval) <- c("Chimpanzee", "Human")
summary(var_pval)
  
# Set p-value

p_val <- 0.05

# P-val < 0.05 for chimps only
  num_var_pval_chimps <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_humans <- var_pval[ which(var_pval[,2] < p_val), ]
  
# Run for the shared
  # Find the p-values of the chimps given that it was significant in the humans

  subset_var <- as.data.frame(var_pval[ which(var_pval[,2] < p_val), 1:2])
  num_var_pval_chimp_given_human_no_df <- subset_var[,1]
  num_var_pval_chimp_given_human <- as.data.frame(subset_var[,1])
 

### Find the Pi_0 estimate for the chimps given significant in the humans

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(num_var_pval_chimps)
shared_p_values_gen <- as.data.frame(num_var_pval_chimp_given_human)



# Pi_0 estimate for the chimps given significant in the humans
pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
shared_p0_given_permutation[i,1] <- pi0est_chimps_given_humans
#print(i)
}

exp_p1 <- 1-mean(shared_p0_given_permutation)
exp_p1
sd_p1 <- sd(1-shared_p0_given_permutation)

1-pnorm(0.55, exp_p1, sd_p1)

```

### Permutation test to find the null hypothesis of sharing (reduction in humans | significant in chimps for day 0 to 1 with p-value cutoff of 0.05) 

```{r}
### Now do the same thing but with humans given significant in chimps


### Make a matrix of the p-values ###

  # Chimp p-values
chimp_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
     x <- t(mean_tech_reps[i,7:10])
     y <- t(mean_tech_reps[i,17:20])
      htest <- var.test(x, y, alternative = c("greater"))
     chimp_var_pval[i,1] <- htest$p.value

}

  # Human p-values

human_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
     x <- t(mean_tech_reps[i,1:6])
     y <- t(mean_tech_reps[i,11:16])
     htest <- var.test(x, y, alternative = c("greater"))
     human_var_pval[i,1] <- htest$p.value
 }

### Matrix for the permuation values

shared_p0_given_permutation_human <- array(NA, dim = c(100000, 1))
  
### Randomize chimp p-values ###  

for(i in 1:100000){
out_p_val <- randomizeMatrix(human_var_pval,null.model = "frequency",iterations = 1000)

var_pval <- as.data.frame(cbind(out_p_val, chimp_var_pval))
rownames(var_pval) <- rownames(mean_tech_reps)
colnames(var_pval) <- c("Human", "Chimpanzee")
summary(var_pval)
  
# Set p-value

p_val <- 0.05

# P-val < 0.05 for chimps only
  num_var_pval_humans <- var_pval[ which(var_pval[,1] < p_val), ]

                    
# P-val < 0.05 for humans only
  num_var_pval_chimps <- var_pval[ which(var_pval[,2] < p_val), ]
  
# Run for the shared
  # Find the p-values of the humans given that it was significant in the chimps

  subset_var <- as.data.frame(var_pval[ which(var_pval[,2] < p_val), 1:2])
  num_var_pval_human_given_chimp_no_df <- subset_var[,1]
  num_var_pval_human_given_chimp <- as.data.frame(subset_var[,1])
 

### Find the Pi_0 estimate for the humans given significant in the chimps

# Obtain pvalues
shared_p_values_gen <- as.data.frame(num_var_pval_human_given_chimp)



# Pi_0 estimate for the humans given significant in the chimps

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
shared_p0_given_permutation_human[i,1] <- pi0est_humans_given_chimps

print(i)
}


comp_mean <- 1-mean(shared_p0_given_permutation_human)
comp_mean

sd_human <- 1-shared_p0_given_permutation_human

1-pnorm(0.84, comp_mean, sd(sd_human))

```


### Estimates of pi0 and pi1 for reduction of variation in chimps conditioned on significance in humans (p = 0.01)

### Changes in variance in chimp samples (p-value cutoff 0.01)

```{r}
# Reduction in variance from day 0 to day 1 chimps

qqplot_red_day01 <- find_qqplot_red_chimps(7,10,17,20,1,6,11,16, 0.01)

# Reduction in variance from day 1 to day 2 chimps

qqplot_red_day12 <- find_qqplot_red_chimps(17,20,27,30,11,16,21,26, 0.01)

# Reduction in variance from day 2 to day 3 chimps

qqplot_red_day23 <- find_qqplot_red_chimps(27,30,37,40,21,26,31,36, 0.01)

# Reduction in variance from day 0 to day 2 chimps

qqplot_red_day02 <- find_qqplot_red_chimps(7,10,27,30,1,6,21,26, 0.01)

# Reduction in variance from day 1 to day 3 chimps

qqplot_red_day13 <- find_qqplot_red_chimps(17,20,37,40,11,16,31,36, 0.01)

# Inc. in variance from day 0 to day 1

qqplot_inc_day01 <- find_qqplot_inc_chimps(7,10,17,20,1,6,11,16, 0.01)

# Inc. in variance from day 1 to day 2

qqplot_inc_day12 <- find_qqplot_inc_chimps(17,20,27,30,11,16,21,26, 0.01)

# Inc. in variance from day 2 to day 3

qqplot_inc_day23 <- find_qqplot_inc_chimps(27,30,37,40,21,26,31,36, 0.01)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_chimps(7,10,27,30,1,6,21,26, 0.01)

# Inc. in variance from day 1 to day 3

qqplot_inc_day13 <- find_qqplot_inc_chimps(17,20,37,40,11,16,31,36, 0.01)

```


### Estimates of pi0 and pi1 for reduction of variation in chimps conditioned on significance in humans (p = 0.01)

```{r}
library("qvalue")
################ REDUCTION IN VARIATION FOR CHIMPS (p = 0.01) ################

# Day 0 to 1


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day01[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.73")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.48")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p1_01

   

# Day 1 to 2


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

# pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0

# Note: There's an issue with estimating pi_0 from only 15 points. 

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.9")', parse=TRUE, x=0.8, y=(pi0est_chimps-0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.8, y=(pi0est_chimps_given_humans+0.07), size = 6)

p3_01

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "black") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.2), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p4_01

```

### Estimates of pi0 and pi1 for increase of variation in chimps conditioned on significance in humans (p = 0.05)

```{r}
############### Increase in Variation ############

# Day 0 to 1

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(nrow(shared_p_values_gen[1]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.80")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p1_inc_01

# Day 1 to 2

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day12[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p2_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.52")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.45")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans-0.07), size = 6)

p2_inc_01

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.37")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.15), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.36")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p3_inc_01

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.51")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.08), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.24")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.08), size = 6)

p4_inc_01
```


### Changes of variation in humans (p = 0.01)

```{r}
# Reduction in variance from day 0 to day 1 humans

qqplot_red_day01 <- find_qqplot_red_humans(7,10,17,20,1,6,11,16, 0.01)

# Reduction in variance from day 1 to day 2 humans

qqplot_red_day12 <- find_qqplot_red_humans(17,20,27,30,11,16,21,26,0.01)

# Reduction in variance from day 2 to day 3 humans

qqplot_red_day23 <- find_qqplot_red_humans(27,30,37,40,21,26,31,36,0.01)

# Reduction in variance from day 1 to day 3 humans

qqplot_red_day13 <- find_qqplot_red_humans(17,20,37,40,11,16,31,36,0.01)

# Reduction in variance from day 0 to day 2 humans

qqplot_red_day02 <- find_qqplot_red_humans(7,10,27,30,1,6,21,26,0.01)

# Inc. in variance from day 0 to day 1 humans

qqplot_inc_day01 <- find_qqplot_inc_humans(7,10,17,20,1,6,11,16,0.01)

# Inc. in variance from day 1 to day 2 humans

qqplot_inc_day12 <- find_qqplot_inc_humans(17,20,27,30,11,16,21,26,0.01)

# Inc. in variance from day 2 to day 3 humans

qqplot_inc_day23 <- find_qqplot_inc_humans(27,30,37,40,21,26,31,36,0.01)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_humans(7,10,27,30,1,6,21,26,0.01)

# Inc. in variance from day ` to day 3 humans

qqplot_inc_day13 <- find_qqplot_inc_humans(17,20,37,40,11,16,31,36,0.01)


```

### Estimates of pi0 and pi1 for reduction of variation in humans conditioned on significance in chimps (p = 0.01)

```{r}

####################### REDUCTION OF VARIATION IN HUMANS (p = 0.01)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.17")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.15")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_01


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p6_01

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.87")', parse=TRUE, x=0.6, y=(pi0est_humans+0.07), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.36")', parse=TRUE, x=0.6, y=(pi0est_humans_given_chimps+0.07), size = 6)

p7_01


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p8_01

multiplot(p1_01,p5_01,p3_01,p6_01, p4_01,p7_01,p8_01,cols=4)
#multiplot(p1_01,p3_01,p4_01,p5_01,p6_01,p7_01,p8_01,cols=2)

```

### Estimates of pi0 and pi1 for increase of variation in humans conditioned on significance in chimps (p = 0.01)

```{r}
####################### INCREASE IN VARIATION IN HUMANS (p = 0.01)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_inc_01


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.21")', parse=TRUE, x=0.2, y=(pi0est_humans+0.32), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.07")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.27), size = 6)

p6_inc_01

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) + scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.85")', parse=TRUE, x=0.2, y=(pi0est_humans+0.05), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.07), size = 6)

p7_inc_01


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_inc_01 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + labs(x = "Unadjusted p-values") + labs(y = "Density") +  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.20")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.35), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.13")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.2), size = 6)

p8_inc_01

multiplot(p1_inc_01,p5_inc_01,p2_inc_01,p6_inc_01,p3_inc_01,p7_inc_01,p4_inc_01,p8_inc_01,cols=4)

```


### Estimates of pi0 and pi1 for reduction of variation in chimps conditioned on significance in humans (p = 0.01)

### Changes in variance in chimp samples (p-value cutoff 0.01)

```{r}
# Reduction in variance from day 0 to day 1 chimps

qqplot_red_day01 <- find_qqplot_red_chimps(7,10,17,20,1,6,11,16, 0.1)

# Reduction in variance from day 1 to day 2 chimps

qqplot_red_day12 <- find_qqplot_red_chimps(17,20,27,30,11,16,21,26, 0.1)

# Reduction in variance from day 2 to day 3 chimps

qqplot_red_day23 <- find_qqplot_red_chimps(27,30,37,40,21,26,31,36, 0.1)

# Reduction in variance from day 0 to day 2 chimps

qqplot_red_day02 <- find_qqplot_red_chimps(7,10,27,30,1,6,21,26, 0.1)

# Reduction in variance from day 1 to day 3 chimps

qqplot_red_day13 <- find_qqplot_red_chimps(17,20,37,40,11,16,31,36, 0.1)

# Inc. in variance from day 0 to day 1

qqplot_inc_day01 <- find_qqplot_inc_chimps(7,10,17,20,1,6,11,16, 0.1)

# Inc. in variance from day 1 to day 2

qqplot_inc_day12 <- find_qqplot_inc_chimps(17,20,27,30,11,16,21,26, 0.1)

# Inc. in variance from day 2 to day 3

qqplot_inc_day23 <- find_qqplot_inc_chimps(27,30,37,40,21,26,31,36, 0.1)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_chimps(7,10,27,30,1,6,21,26, 0.1)

# Inc. in variance from day 1 to day 3

qqplot_inc_day13 <- find_qqplot_inc_chimps(17,20,37,40,11,16,31,36, 0.1)

```


### Estimates of pi0 and pi1 for reduction of variation in chimps conditioned on significance in humans (p = 0.1)

```{r}
library("qvalue")
################ REDUCTION IN VARIATION FOR CHIMPS (p = 0.1) ################

# Day 0 to 1


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day01[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.73")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.52")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p1_10

   

# Day 1 to 2


# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day12[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p2_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) + scale_y_continuous(labels=scaleFUN) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.5, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.72")', parse=TRUE, x=0.5, y=(pi0est_chimps_given_humans+0.07), size = 6)

p2_10

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.9")', parse=TRUE, x=0.8, y=(pi0est_chimps-0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.8, y=(pi0est_chimps_given_humans+0.07), size = 6)

p3_10

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_red_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "black") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.17), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p4_10

```

### Estimates of pi0 and pi1 for increase of variation in chimps conditioned on significance in humans (p = 0.10)

```{r}
############### Increase in Variation ############

# Day 0 to 1

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(nrow(shared_p_values_gen[1]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p1_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="1")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.92")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans-0.07), size = 6)

p1_inc_10

# Day 1 to 2

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day12[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p2_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.52")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.07), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.33")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p2_inc_10

# Day 2 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day23[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p3_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.37")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.13), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.35")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans+0.07), size = 6)

p3_inc_10

# Day 1 to 3

# Obtain pvalues
chimp_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])

# Pi_0 estimate for the chimps

pi0est_chimps <- qvalue(p=chimp_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps

# Pi_1 estimate for the chimps

pi1est_chimps <- 1 - pi0est_chimps
pi1est_chimps

# Pi_0 estimate for the chimps given significant in the humans

pi0est_chimps_given_humans <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_chimps_given_humans

# Pi_1 estimate for the humans

pi1est_chimps_given_humans <- 1 - pi0est_chimps_given_humans
pi1est_chimps_given_humans

# Let's overlap the two histograms

labels_c <- array("Chimpanzee", dim = c(10304,1))
labels_h <- array("Shared (Chimpanzee|Significant in Humans)", dim = c(as.data.frame(qqplot_inc_day13[[3]][2]),1))

chimps <- cbind(labels_c, chimp_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, shared_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(chimps[,1:2], humans[,1:2])

pal <- c("#00A4F4", "#E77642", "white") 

p4_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[2:3]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_chimps_given_humans, size = 2.5) + 
  geom_hline(yintercept = pi0est_chimps, size = 2.5, color = "#E77642") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", chimps"])=="0.51")', parse=TRUE, x=0.2, y=(pi0est_chimps+0.08), colour = "#E77642", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.42")', parse=TRUE, x=0.2, y=(pi0est_chimps_given_humans-0.08), size = 6)

p4_inc_10
```


### Changes of variation in humans (p = 0.10)

```{r}
# Reduction in variance from day 0 to day 1 humans

qqplot_red_day01 <- find_qqplot_red_humans(7,10,17,20,1,6,11,16, 0.1)

# Reduction in variance from day 1 to day 2 humans

qqplot_red_day12 <- find_qqplot_red_humans(17,20,27,30,11,16,21,26,0.1)

# Reduction in variance from day 2 to day 3 humans

qqplot_red_day23 <- find_qqplot_red_humans(27,30,37,40,21,26,31,36,0.1)

# Reduction in variance from day 1 to day 3 humans

qqplot_red_day13 <- find_qqplot_red_humans(17,20,37,40,11,16,31,36,0.1)

# Reduction in variance from day 0 to day 2 humans

qqplot_red_day02 <- find_qqplot_red_humans(7,10,27,30,1,6,21,26,0.1)

# Inc. in variance from day 0 to day 1 humans

qqplot_inc_day01 <- find_qqplot_inc_humans(7,10,17,20,1,6,11,16,0.1)

# Inc. in variance from day 1 to day 2 humans

qqplot_inc_day12 <- find_qqplot_inc_humans(17,20,27,30,11,16,21,26,0.1)

# Inc. in variance from day 2 to day 3 humans

qqplot_inc_day23 <- find_qqplot_inc_humans(27,30,37,40,21,26,31,36,0.1)

# Inc. in variance from day 0 to day 2

qqplot_inc_day02 <- find_qqplot_inc_humans(7,10,27,30,1,6,21,26,0.1)

# Inc. in variance from day ` to day 3 humans

qqplot_inc_day13 <- find_qqplot_inc_humans(17,20,37,40,11,16,31,36,0.1)


```

### Estimates of pi0 and pi1 for reduction of variation in humans conditioned on significance in chimps (p = 0.10)

```{r}

####################### REDUCTION OF VARIATION IN HUMANS (p = 0.10)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.17")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.15")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_10


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p6_10

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.87")', parse=TRUE, x=0.7, y=(pi0est_humans+0.06), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.76")', parse=TRUE, x=0.7, y=(pi0est_humans_given_chimps+0.06), size = 6)

p7_10


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_red_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_red_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_red_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p8_10

multiplot(p1_10,p5_10,p2_10,p6_10,p3_10,p7_10,p4_10,p8_10,cols=4)

```

### Estimates of pi0 and pi1 for increase of variation in humans conditioned on significance in chimps (p = 0.10)

```{r}
####################### INCREASE IN VARIATION IN HUMANS (p = 0.1)


# Day 0 to 1

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day01[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day01[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day01[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p5_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 0 to 1") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.15), size = 6)

p5_inc_10


# Day 1 to 2

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day12[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day12[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day12[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p6_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 1 to 2") + theme(plot.title = element_text(face = "bold")) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + 
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.21")', parse=TRUE, x=0.2, y=(pi0est_humans+0.28), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.10")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.25), size = 6)

p6_inc_10

# Day 2 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day23[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day23[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day23[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p7_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) +
  theme_bw() +  labs(title = "Day 2 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) +  labs(x = "Unadjusted p-values") + labs(y = "Density") + scale_y_continuous(labels=scaleFUN) +
  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.85")', parse=TRUE, x=0.2, y=(pi0est_humans+0.07), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="1")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.07), size = 6)

p7_inc_10


# Day 1 to 3

# Obtain pvalues
human_p_values_gen <- as.data.frame(qqplot_inc_day13[1])
shared_p_values_gen <- as.data.frame(qqplot_inc_day13[2])


# Pi_0 estimate for the humans

pi0est_humans <- qvalue(p= human_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans

# Pi_1 estimate for the humans

pi1est_humans <- 1 - pi0est_humans
pi1est_humans

# Pi_0 estimate for the chimps given significant in the humans

pi0est_humans_given_chimps <- qvalue(p=shared_p_values_gen, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
pi0est_humans_given_chimps

# Pi_1 estimate for the humans

pi1est_humans_given_chimps <- 1 - pi0est_humans_given_chimps
pi1est_humans_given_chimps

# Let's overlap the two histograms

labels_h <- array("Human", dim = c(10304,1))
labels_c <- array("Shared (Human|Significant in Chimps)", dim = c(as.data.frame(qqplot_inc_day13[[3]][1]),1))

chimps <- cbind(labels_c, shared_p_values_gen)
colnames(chimps) <- c("Species", "pval")
humans <- cbind(labels_h, human_p_values_gen)
colnames(humans) <- c("Species", "pval")

# Combine the two

all_pval <- rbind(humans[,1:2], chimps[,1:2])

pal <- c("#00A4F4", "white") 

p8_inc_10 <- ggplot(all_pval, aes(pval, fill = Species)) + scale_fill_manual(values=pal[1:2]) +
  geom_density(show.legend = F, alpha = 1) +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.25)) + scale_y_continuous(labels=scaleFUN) +
  theme_bw() +  labs(title = "Day 1 to 3") + theme(plot.title = element_text(face = "bold")) + 
  geom_hline(yintercept = pi0est_humans_given_chimps, size = 2.5) + labs(x = "Unadjusted p-values") + labs(y = "Density") +  geom_hline(yintercept = pi0est_humans, size = 2.5, color = "#00A4F4") +       
  annotate("text", label= 'bold(bolditalic(hat(pi)[0][", humans"])=="0.20")', parse=TRUE, x=0.2, y=(pi0est_humans+0.3), colour = "#00A4F4", size = 6) +  annotate("text", label = 'bold(bolditalic(hat(pi)[0][", shared"])=="0.16")', parse=TRUE, x=0.2, y=(pi0est_humans_given_chimps+0.17), size = 6)

p8_inc_10

multiplot(p1_inc_10,p5_inc_10,p2_inc_10,p6_inc_10,p3_inc_10,p7_inc_10,p4_inc_10,p8_inc_10,cols=4)


```





### Sharing estimates (chimps conditioned on humans) for x number of significant genes (p = 0.05 cutoff)
```{r}
find_qqplot_red_top_all_sharing_chimps <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    chimp_var_pval[i,1] <- htest$p.value
  }

 # hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    human_var_pval[i,1] <- htest$p.value
  }

  #hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(human_var_pval, chimp_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Human", "Chimpanzee")
  summary(var_pval)

  dim(var_pval)

# Convert to data frame
  top_var_pval <- var_pval[order(var_pval[,1]), ]
  
# Instead of going by p < 0.05, take the top x number of p-values
  for_pi1_var_pval <- array(NA, dim = c(10205, 2))
  
  for(i in 100:10304){
    num_var_pval <- top_var_pval[1:i, 1:2]
  
# Get humans
    num_var_pval_chimps_i <- top_var_pval[1:i, 1]
  
# Get sharing
    num_var_pval_shared_i <- top_var_pval[1:i, 2]
  

# Pi_0 estimate for the humans given significant in the chimps
  pi0est_humans_given_chimps_i <- qvalue(p=num_var_pval_shared_i, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0
  
 



# Pi_1 estimate for the humans
  for_pi1_var_pval[i-99,1] <- i
  for_pi1_var_pval[i-99,2] <- 1 - pi0est_humans_given_chimps_i
  #print(i)
  }
  
  return(for_pi1_var_pval)
}

find_qqplot_inc_top_all_sharing_chimps <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  #hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    human_var_pval[i,1] <- htest$p.value
  }

  #hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind( human_var_pval, chimp_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c( "Human", "Chimpanzee")
  summary(var_pval)

  dim(var_pval)

# Convert to data frame
  top_var_pval <- var_pval[order(var_pval[,1]), ]
  
# Instead of going by p < 0.05, take the top x number of p-values
  for_pi1_var_pval <- array(NA, dim = c(10205, 2))
  
  for(i in 100:10304){
    num_var_pval <- top_var_pval[1:i, 1:2]
  
# Get humans
    num_var_pval_chimps_i <- top_var_pval[1:i, 1]
  
# Get sharing
    num_var_pval_shared_i <- top_var_pval[1:i, 2]
  

# Pi_0 estimate for the humans given significant in the chimps
  pi0est_humans_given_chimps_i <- qvalue(p=num_var_pval_shared_i, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0


# Pi_1 estimate for the humans
  for_pi1_var_pval[i-99,1] <- i
  for_pi1_var_pval[i-99,2] <- 1 - pi0est_humans_given_chimps_i
  #print(i)
  }
  return(for_pi1_var_pval)
}

# Reduction in variance from day 0 to day 1

qqplot_red_top_all_day01 <- find_qqplot_red_top_all_sharing_chimps(7,10,17,20,1,6,11,16)

# Reduction in variance from day 1 to day 2

qqplot_red_top_all_day12 <- find_qqplot_red_top_all_sharing_chimps(17,20,27,30,11,16,21,26)

# Reduction in variance from day 2 to day 3

qqplot_red_top_all_day23 <- find_qqplot_red_top_all_sharing_chimps(27,30,37,40,21,26,31,36)

# Reduction in variance from day 0 to day 2

qqplot_red_top_all_day02 <- find_qqplot_red_top_all_sharing_chimps(7,10,27,30,1,6,21,26)

# Reduction in variance from day 1 to day 3

qqplot_red_top_all_day13 <- find_qqplot_red_top_all_sharing_chimps(17,20,37,40,11,16,31,36)

# Inc. in variance from day 0 to day 1

qqplot_inc_top_all_day01 <- find_qqplot_inc_top_all_sharing_chimps(7,10,17,20,1,6,11,16)

# Inc. in variance from day 1 to day 2

qqplot_inc_top_all_day12 <- find_qqplot_inc_top_all_sharing_chimps(17,20,27,30,11,16,21,26)

# Inc. in variance from day 2 to day 3

qqplot_inc_top_all_day23 <- find_qqplot_inc_top_all_sharing_chimps(27,30,37,40,21,26,31,36)

# Inc. in variance from day 0 to day 2

qqplot_inc_top_all_day02 <- find_qqplot_inc_top_all_sharing_chimps(7,10,27,30,1,6,21,26)

# Inc. in variance from day 1 to day 3

qqplot_inc_top_all_day13 <- find_qqplot_inc_top_all_sharing_chimps(17,20,37,40,11,16,31,36)

# Make everything a data frame
qqplot_red_top_all_day01 <- as.data.frame(qqplot_red_top_all_day01)
qqplot_red_top_all_day12 <- as.data.frame(qqplot_red_top_all_day12)
qqplot_red_top_all_day23 <- as.data.frame(qqplot_red_top_all_day23)
qqplot_red_top_all_day02 <- as.data.frame(qqplot_red_top_all_day02)
qqplot_red_top_all_day13 <- as.data.frame(qqplot_red_top_all_day13)
qqplot_inc_top_all_day01 <- as.data.frame(qqplot_inc_top_all_day01)
qqplot_inc_top_all_day12 <- as.data.frame(qqplot_inc_top_all_day12)
qqplot_inc_top_all_day23 <- as.data.frame(qqplot_inc_top_all_day23)
qqplot_inc_top_all_day02 <- as.data.frame(qqplot_inc_top_all_day02)
qqplot_inc_top_all_day13 <- as.data.frame(qqplot_inc_top_all_day13)

# Plots of pi_0

qqplot_red_top_all_day01_pi0 <- abs(1- qqplot_red_top_all_day01)
qqplot_red_top_all_day12_pi0 <- abs(1- qqplot_red_top_all_day12)
qqplot_red_top_all_day23_pi0 <- abs(1- qqplot_red_top_all_day23)
qqplot_red_top_all_day02_pi0 <- abs(1- qqplot_red_top_all_day02)
qqplot_red_top_all_day13_pi0 <- abs(1- qqplot_red_top_all_day13)
qqplot_inc_top_all_day01_pi0 <- abs(1- qqplot_inc_top_all_day01)
qqplot_inc_top_all_day12_pi0 <- abs(1- qqplot_inc_top_all_day12)
qqplot_inc_top_all_day23_pi0 <- abs(1- qqplot_inc_top_all_day23)
qqplot_inc_top_all_day02_pi0 <- abs(1- qqplot_inc_top_all_day02)
qqplot_inc_top_all_day13_pi0 <- abs(1- qqplot_inc_top_all_day13)

# Plot reduction in variation
p_top_genes_red_var_chimps <- ggplot(qqplot_red_top_all_day01_pi0, aes(x = qqplot_red_top_all_day01_pi0[,1], y = qqplot_red_top_all_day01_pi0[,2])) + geom_line(colour="#00B451") + theme_bw() + geom_line(aes(x = qqplot_red_top_all_day12_pi0[,1], y = qqplot_red_top_all_day12_pi0[,2]-0.001), colour =  "#00B1DB") + geom_line(aes(x = qqplot_red_top_all_day23_pi0[,1], y = qqplot_red_top_all_day23_pi0[,2]), colour =  "#C77CFF") + geom_line(aes(x = qqplot_red_top_all_day13_pi0[,1], y = qqplot_red_top_all_day13_pi0[,2]+0.001), colour = "#000000") + ylim(0,1.01) + ggtitle(expression( italic(hat(pi)[0]) ~ "For Reduction in Variance (Chimpanzees|Sign. in Humans)" )) + xlab("N Most Significant Genes in Humans") + ylab(expression( italic(hat(pi)[0]) ~ "(Chimps|Sign. in Humans)")) 

p_top_genes_red_var_chimps

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)



# Plot of Increase in Variation

p_top_genes_inc_var_chimps <- ggplot(qqplot_inc_top_all_day01_pi0, aes(x = qqplot_inc_top_all_day01_pi0[,1], y = qqplot_inc_top_all_day01_pi0[,2]+0.001)) + geom_line(colour="#00B451") + theme_bw() + geom_line(aes(x = qqplot_inc_top_all_day12_pi0[,1], y = qqplot_inc_top_all_day12_pi0[,2]), colour = "#00B1DB") + geom_line(aes(x = qqplot_inc_top_all_day23_pi0[,1], y = qqplot_inc_top_all_day23_pi0[,2]-0.001), colour =  "#C77CFF") + geom_line(aes(x = qqplot_inc_top_all_day13_pi0[,1], y = qqplot_inc_top_all_day13_pi0[,2]), colour = "#000000") + ylim(0,1.01) + ggtitle(expression( italic(hat(pi)[0]) ~ "For Increase in Variance (Chimpanzees|Sign. in Humans)" )) + xlab("N Most Significant Genes in Humans") + ylab(expression( italic(hat(pi)[0]) ~ "(Chimps|Sign. in Humans)")) 

p_top_genes_inc_var_chimps

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)

# Plots of pi_1

#dev.off()
# Plot reduction in variation
#ggplot(qqplot_red_top_all_day01, aes(x = qqplot_red_top_all_day01[,1], y = qqplot_red_top_all_day01[,2])) + geom_line(colour="#E69F00") + theme_bw() + geom_line(aes(x = qqplot_red_top_all_day12[,1], y = qqplot_red_top_all_day12[,2]), colour = "#000000") + geom_line(aes(x = qqplot_red_top_all_day23[,1], y = qqplot_red_top_all_day23[,2]), colour =  "#009E73") + geom_line(aes(x = qqplot_red_top_all_day13[,1], y = qqplot_red_top_all_day13[,2]), colour =  "#0072B2") + ylim(0,1) + ggtitle("Proportion of Shared Genes with a Reduction in Variance between Days") + xlab("N Most Significant Genes in Humans") + ylab(expression( italic(hat(pi)[1]) ~ "(Chimpanzees|Significant in Humans)")) 

#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
#plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
#legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#E69F00", "#000000",  "#009E73","#0072B2" ), cex = 1)


# Plot inc in variation
#ggplot(qqplot_inc_top_all_day01, aes(x = qqplot_inc_top_all_day01[,1], y = qqplot_inc_top_all_day01[,2])) + geom_line(colour="#E69F00") + theme_bw() + geom_line(aes(x = qqplot_inc_top_all_day12[,1], y = qqplot_inc_top_all_day12[,2]), colour = "#000000") + geom_line(aes(x = qqplot_inc_top_all_day23[,1], y = qqplot_inc_top_all_day23[,2]), colour =  "#009E73") + geom_line(aes(x = qqplot_inc_top_all_day13[,1], y = qqplot_inc_top_all_day13[,2]), colour =  "#0072B2") + ylim(0,1) + ggtitle("Proportion of Shared Genes with an Increase in Variance between Days") + xlab("N Most Significant Genes in Humans") + ylab(expression( italic(hat(pi)[1]) ~ "(Chimpanzees|Significant in Humans)")) 
 

#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
#plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
#legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#E69F00", "#000000",  "#009E73","#0072B2" ), cex = 1)

# ggplot(qqplot_inc_top_all_day01, aes(x = qqplot_inc_top_all_day01[,1], y = qqplot_inc_top_all_day01[,2])) + geom_line(colour="#E69F00") + theme_bw() + geom_line(aes(x = qqplot_inc_top_all_day12[,1], y = qqplot_inc_top_all_day12[,2]), colour = "#000000") + geom_line(aes(x = qqplot_inc_top_all_day23[,1], y = qqplot_inc_top_all_day23[,2]), colour =  "#009E73") + geom_line(aes(x = qqplot_inc_top_all_day13[,1], y = qqplot_inc_top_all_day13[,2]), colour =  "#0072B2") + ylim(0,1) + ggtitle("Proportion of Shared Genes with an Increase in Variance between Days") + xlab("N Most Significant Genes in Humans") + ylab(expression( italic(hat(pi)[1]) ~ "(Chimpanzees|Significant in Humans)")) 

```


### Sharing estimates (humans conditioned on chimps) for x number of significant genes
```{r}
find_qqplot_red_top_all_humans <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("greater"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Convert to data frame
  top_var_pval <- var_pval[order(var_pval[,1]), ]
  
# Instead of going by p < 0.05, take the top x number of p-values
  for_pi1_var_pval <- array(NA, dim = c(10205, 2))
  
  for(i in 100:10304){
    num_var_pval <- top_var_pval[1:i, 1:2]
  
# Get chimps
    num_var_pval_chimps_i <- top_var_pval[1:i, 1]
  
# Get sharing
    num_var_pval_shared_i <- top_var_pval[1:i, 2]
  

# Pi_0 estimate for the humans given significant in the chimps
  pi0est_humans_given_chimps_i <- qvalue(p=num_var_pval_shared_i, pi0.method="smoother", fdr.level=NULL, robust=TRUE)$pi0


# Pi_1 estimate for the humans
  for_pi1_var_pval[i-99,1] <- i
  for_pi1_var_pval[i-99,2] <- 1 - pi0est_humans_given_chimps_i
  #print(i)
  }
  return(for_pi1_var_pval)
}

find_qqplot_inc_top_all_humans <- function(chimp_begin_column_tm1, chimp_end_column_tm1, chimp_begin_column_t, chimp_end_column_t, human_begin_column_tm1, human_end_column_tm1, human_begin_column_t, human_end_column_t){

  # Make an array to store the Chimp p-values

  chimp_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,chimp_begin_column_tm1:chimp_end_column_tm1])
    y <- t(mean_tech_reps[i,chimp_begin_column_t:chimp_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    chimp_var_pval[i,1] <- htest$p.value
  }

  hist(chimp_var_pval)

############## For humans

  human_var_pval <- array(NA, dim = c(10304, 1))

  for(i in 1:10304){
    x <- t(mean_tech_reps[i,human_begin_column_tm1:human_end_column_tm1])
    y <- t(mean_tech_reps[i,human_begin_column_t:human_end_column_t])
    htest <- var.test(x, y, alternative = c("less"))
    human_var_pval[i,1] <- htest$p.value
  }

  hist(human_var_pval)

############ Find p-values of the F_statistics

# Make one data frame

  var_pval <- as.data.frame(cbind(chimp_var_pval, human_var_pval))
  rownames(var_pval) <- rownames(mean_tech_reps)
  colnames(var_pval) <- c("Chimpanzee", "Human")
  summary(var_pval)

  dim(var_pval)

# Convert to data frame
  top_var_pval <- var_pval[order(var_pval[,1]), ]
  
# Instead of going by p < 0.05, take the top x number of p-values
  for_pi1_var_pval <- array(NA, dim = c(10205, 2))
  
  for(i in 100:10304){
    num_var_pval <- top_var_pval[1:i, 1:2]
  
# Get chimps
    num_var_pval_chimps_i <- top_var_pval[1:i, 1]
  
# Get sharing
    num_var_pval_shared_i <- top_var_pval[1:i, 2]
  

# Pi_0 estimate for the humans given significant in the chimps
  pi0est_humans_given_chimps_i <- pi0est(num_var_pval_shared_i, lambda = seq(0.05, 0.95, 0.05))$pi0


# Pi_1 estimate for the humans
  for_pi1_var_pval[i-99,1] <- i
  for_pi1_var_pval[i-99,2] <- 1 - pi0est_humans_given_chimps_i
#  print(i)
  }
  return(for_pi1_var_pval)
}

# Reduction in variance from day 0 to day 1

qqplot_red_top_all_day01_humans <- find_qqplot_red_top_all_humans(7,10,17,20,1,6,11,16)

# Reduction in variance from day 1 to day 2

qqplot_red_top_all_day12_humans <- find_qqplot_red_top_all_humans(17,20,27,30,11,16,21,26)

# Reduction in variance from day 2 to day 3

qqplot_red_top_all_day23_humans  <- find_qqplot_red_top_all_humans(27,30,37,40,21,26,31,36)

# Reduction in variance from day 0 to day 2

qqplot_red_top_all_day02_humans  <- find_qqplot_red_top_all_humans(7,10,27,30,1,6,21,26)

# Reduction in variance from day 1 to day 3

qqplot_red_top_all_day13_humans  <- find_qqplot_red_top_all_humans(17,20,37,40,11,16,31,36)

# Inc. in variance from day 0 to day 1

qqplot_inc_top_all_day01_humans  <- find_qqplot_inc_top_all_humans(7,10,17,20,1,6,11,16)

# Inc. in variance from day 1 to day 2

qqplot_inc_top_all_day12_humans  <- find_qqplot_inc_top_all_humans(17,20,27,30,11,16,21,26)

# Inc. in variance from day 2 to day 3

qqplot_inc_top_all_day23_humans  <- find_qqplot_inc_top_all_humans(27,30,37,40,21,26,31,36)

# Inc. in variance from day 0 to day 2

qqplot_inc_top_all_day02_humans  <- find_qqplot_inc_top_all_humans(7,10,27,30,1,6,21,26)

# Inc. in variance from day 1 to day 3

qqplot_inc_top_all_day13_humans  <- find_qqplot_inc_top_all_humans(17,20,37,40,11,16,31,36)


# Make everything a data frame
qqplot_red_top_all_day01_humans  <- as.data.frame(qqplot_red_top_all_day01_humans)
qqplot_red_top_all_day12_humans  <- as.data.frame(qqplot_red_top_all_day12_humans)
qqplot_red_top_all_day23_humans  <- as.data.frame(qqplot_red_top_all_day23_humans)
qqplot_red_top_all_day02_humans  <- as.data.frame(qqplot_red_top_all_day02_humans)
qqplot_red_top_all_day13_humans  <- as.data.frame(qqplot_red_top_all_day13_humans)
qqplot_inc_top_all_day01_humans  <- as.data.frame(qqplot_inc_top_all_day01_humans)
qqplot_inc_top_all_day12_humans  <- as.data.frame(qqplot_inc_top_all_day12_humans)
qqplot_inc_top_all_day23_humans  <- as.data.frame(qqplot_inc_top_all_day23_humans)
qqplot_inc_top_all_day02_humans  <- as.data.frame(qqplot_inc_top_all_day02_humans)
qqplot_inc_top_all_day13_humans  <- as.data.frame(qqplot_inc_top_all_day13_humans)

# Plots of pi_0

qqplot_red_top_all_day01_pi0_humans  <- abs(1- qqplot_red_top_all_day01_humans)
qqplot_red_top_all_day12_pi0_humans  <- abs(1- qqplot_red_top_all_day12_humans)
qqplot_red_top_all_day23_pi0_humans  <- abs(1- qqplot_red_top_all_day23_humans)
qqplot_red_top_all_day02_pi0_humans  <- abs(1- qqplot_red_top_all_day02_humans)
qqplot_red_top_all_day13_pi0_humans  <- abs(1- qqplot_red_top_all_day13_humans)
qqplot_inc_top_all_day01_pi0_humans  <- abs(1- qqplot_inc_top_all_day01_humans)
qqplot_inc_top_all_day12_pi0_humans  <- abs(1- qqplot_inc_top_all_day12_humans)
qqplot_inc_top_all_day23_pi0_humans  <- abs(1- qqplot_inc_top_all_day23_humans)
qqplot_inc_top_all_day02_pi0_humans  <- abs(1- qqplot_inc_top_all_day02_humans)
qqplot_inc_top_all_day13_pi0_humans  <- abs(1- qqplot_inc_top_all_day13_humans)

# Plots of pi_0

p_top_genes_red_var_humans <- ggplot(qqplot_red_top_all_day01_pi0_humans, aes(x = qqplot_red_top_all_day01_pi0_humans[,1], y = qqplot_red_top_all_day01_pi0_humans[,2])) + geom_line(colour="#00B451") + theme_bw() + geom_line(aes(x = qqplot_red_top_all_day12_pi0_humans[,1], y = qqplot_red_top_all_day12_pi0_humans[,2]+0.001), colour = "#00B1DB") + geom_line(aes(x = qqplot_red_top_all_day23_pi0_humans[,1], y = qqplot_red_top_all_day23_pi0_humans[,2]), colour =  "#C77CFF") + geom_line(aes(x = qqplot_red_top_all_day13_pi0_humans[,1], y = qqplot_red_top_all_day13_pi0_humans[,2]-0.001), colour =  "#000000") + ylim(0,1.01) + ggtitle(expression( italic(hat(pi)[0]) ~ "For Reduction in Variance Between Days (Humans|Sign. Chimps)" )) + xlab("N Most Significant Genes in Chimpanzees") + ylab(expression( italic(hat(pi)[0]) ~ "(Humans|Sign. in Chimps)")) 
p_top_genes_red_var_humans

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 
    0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)

p_top_genes_inc_var_humans <- ggplot(qqplot_inc_top_all_day01_pi0_humans, aes(x = qqplot_inc_top_all_day01_pi0_humans[,1], y = qqplot_inc_top_all_day01_pi0_humans[,2]+0.001)) + geom_line(colour="#00B451") + theme_bw() + geom_line(aes(x = qqplot_inc_top_all_day12_pi0_humans[,1], y = qqplot_inc_top_all_day12_pi0_humans[,2]), colour = "#00B1DB") + geom_line(aes(x = qqplot_inc_top_all_day23_pi0_humans[,1], y = qqplot_inc_top_all_day23_pi0_humans[,2]-0.001), colour =  "#C77CFF") + geom_line(aes(x = qqplot_inc_top_all_day13_pi0_humans[,1], y = qqplot_inc_top_all_day13_pi0_humans[,2]), colour =  "#000000" ) + ylim(0,1.01) + ggtitle(expression( italic(hat(pi)[0]) ~ "For Increase in Variance Between Days (Humans|Significant in Chimpanzees)" )) + xlab("N Most Significant Genes in Chimpanzees") + ylab(expression( italic(hat(pi)[0]) ~ "(Humans|Significant in Chimpanzees)")) 
p_top_genes_inc_var_humans

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 
    0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)


# Export plots

multiplot(p_top_genes_red_var_chimps,p_top_genes_red_var_humans,cols=1)

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 
    0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)

multiplot(p_top_genes_inc_var_chimps,p_top_genes_inc_var_humans,cols=1)

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 
    0), bty = "n", pch = c(15, 15, 15, 15), col = c("#00B451", "#00B1DB",  "#C77CFF","#000000" ), cex = 1)

# Plots of pi_1

# Plot reduction in variation
#ggplot(qqplot_red_top_all_day01, aes(x = qqplot_red_top_all_day01[,1], y = qqplot_red_top_all_day01[,2])) + geom_line(colour="#E69F00") + theme_bw() + geom_line(aes(x = qqplot_red_top_all_day12[,1], y = qqplot_red_top_all_day12[,2]), colour = "#000000") + geom_line(aes(x = qqplot_red_top_all_day23[,1], y = qqplot_red_top_all_day23[,2]), colour =  "#009E73") + geom_line(aes(x = qqplot_red_top_all_day13[,1], y = qqplot_red_top_all_day13[,2]), colour =  "#0072B2") + ggtitle(expression( italic(hat(pi)[1]) ~ "For Reduction in Variance Between Days (Humans|Significant in Chimpanzees)" )) + xlab("N Most Significant Genes in Chimpanzees") + ylab(expression( italic(hat(pi)[1]) ~ "(Humans|Significant in Chimpanzees)")) 

#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
#plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
#legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#E69F00", "#000000",  "#009E73","#0072B2" ), cex = 1)


# Plot inc in variation
#ggplot(qqplot_inc_top_all_day01, aes(x = qqplot_inc_top_all_day01[,1], y = qqplot_inc_top_all_day01[,2])) + geom_line(colour="#E69F00") + theme_bw() + geom_line(aes(x = qqplot_inc_top_all_day12[,1], y = qqplot_inc_top_all_day12[,2]), colour = "#000000") + geom_line(aes(x = qqplot_inc_top_all_day23[,1], y = qqplot_inc_top_all_day23[,2]), colour =  "#009E73") + geom_line(aes(x = qqplot_inc_top_all_day13[,1], y = qqplot_inc_top_all_day13[,2]), colour =  "#0072B2") + ggtitle(expression( italic(hat(pi)[1]) ~ "For Increase in Variance Between Days (Humans|Significant in Chimpanzees)" )) + xlab("N Most Significant Genes in Chimpanzees") + ylab(expression( italic(hat(pi)[1]) ~ "(Humans|Significant in Chimpanzees)")) 

#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
#plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
#legend("right", c("Day 0 to 1", "Day 1 to 2", "Day 2 to 3", "Day 1 to 3"), xpd = TRUE, horiz = FALSE, inset = c(0, 0), bty = "n", pch = c(15, 15, 15, 15), col = c("#E69F00", "#000000",  "#009E73","#0072B2" ), cex = 1)


```

### Note: code to make other figures

```{r}
# 6A) 
multiplot(p1s,p3s,p2s,p3_13s, cols=2)

# 6B)
multiplot(p1s,p3s,p2s,p3_13s, cols=2)

# 6C-F)

multiplot(p1_05, p2_inc_05, p5_05,  p6_inc_05, cols=2)


# SF 12A) 
multiplot(p1,p2,p3,p3_13, cols=2)
# SF12 B)
multiplot(p4,p5,p6,p6_13, cols=2)

# SF13 A)
multiplot(p2_05, p3_05,p4_05,cols=2)
# SF13 B)
multiplot(p6_05, p7_05,p8_05,cols=2)
# SF13 C)
multiplot(p1_inc_05, p3_inc_05,p4_inc_05,cols=2)
# SF13 D)
multiplot(p5_inc_05, p7_inc_05,p8_inc_05,cols=2)


# SF14 E)
multiplot(p1_01, p3_01,p4_01,cols=2)
# SF14 F)
multiplot(p5_01, p6_01, p7_01,p8_01,cols=2)
# SF14 G)
multiplot(p1_inc_01, p2_inc_01, p3_inc_01,p4_inc_01,cols=2)
# SF14 H)
multiplot(p5_inc_01, p6_inc_01, p7_inc_01,p8_inc_01,cols=2)
# SF14 I)
multiplot(p1_10, p2_10, p3_10,p4_10,cols=2)
# SF14 J)
multiplot(p5_10, p6_10, p7_10,p8_10,cols=2)
# SF14 K)
multiplot(p1_inc_10, p2_inc_10, p3_inc_10,p4_inc_10,cols=2)
# SF14 L)
multiplot(p5_inc_10, p6_inc_10, p7_inc_10,p8_inc_10,cols=2)

```





### Gene names showing reduction (increase) in variance from days 0 to 1 (days 1 to 2)

```{r}

# Reduction Day 0 to 1 chimps

chimp_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
    x <- t(mean_tech_reps[i,7:10])
    y <- t(mean_tech_reps[i,17:20])
    htest <- var.test(x, y, alternative = c("greater"))
    chimp_var_pval[i,1] <- htest$p.value
}
rownames(chimp_var_pval) <- rownames(mean_tech_reps)
length(which(chimp_var_pval < 0.05))

chimp_red_01 <- as.data.frame(chimp_var_pval[which(chimp_var_pval < 0.05), ])
dim(chimp_red_01)
write.table(chimp_red_01,file="~/Desktop/Endoderm_TC/ashlar-trial/data/red_chimps_day0_1.txt",sep="\t", col.names = T, row.names = T)


# Reduction Day 0 to 1 humans
human_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
    x <- t(mean_tech_reps[i,1:6])
    y <- t(mean_tech_reps[i,11:16])
    htest <- var.test(x, y, alternative = c("greater"))
    human_var_pval[i,1] <- htest$p.value
}
rownames(human_var_pval) <- rownames(mean_tech_reps)
length(which(human_var_pval < 0.05))

human_red_01 <- as.data.frame(human_var_pval[which(human_var_pval < 0.05), ])
dim(human_red_01)
write.table(human_red_01,file="~/Desktop/Endoderm_TC/ashlar-trial/data/red_human_day0_1.txt",sep="\t", col.names = T, row.names = T)


# Increase Day 1 to 2 chimps
chimp_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
    x <- t(mean_tech_reps[i,17:20])
    y <- t(mean_tech_reps[i,27:30])
    htest <- var.test(x, y, alternative = c("less"))
    chimp_var_pval[i,1] <- htest$p.value
}
rownames(chimp_var_pval) <- rownames(mean_tech_reps)
length(which(chimp_var_pval < 0.05))

chimp_inc_12 <- as.data.frame(chimp_var_pval[which(chimp_var_pval < 0.05), ])
dim(chimp_inc_12)
write.table(chimp_inc_12,file="~/Desktop/Endoderm_TC/ashlar-trial/data/inc_chimps_day1_2.txt",sep="\t", col.names = T, row.names = T)


# Increase Day 1 to 2 humans
human_var_pval <- array(NA, dim = c(10304, 1))

for(i in 1:10304){
    x <- t(mean_tech_reps[i,11:16])
    y <- t(mean_tech_reps[i,21:26])
    htest <- var.test(x, y, alternative = c("less"))
    human_var_pval[i,1] <- htest$p.value
}
rownames(human_var_pval) <- rownames(mean_tech_reps)
length(which(human_var_pval < 0.05))

human_inc_12 <- as.data.frame(human_var_pval[which(human_var_pval < 0.05), ])
dim(human_inc_12)
write.table(human_inc_12,file="~/Desktop/Endoderm_TC/ashlar-trial/data/inc_human_day1_2.txt",sep="\t", col.names = T, row.names = T)

```

