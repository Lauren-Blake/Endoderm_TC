---
title: "Cormotif_avg_log2(CPM)"
author: "Lauren Blake"
date: "January 8, 2017"
output: html_document
---

The goal of this script is to perform the main analyses and the supplemental analyses using Cormotif. 

## 

```{r}
library("edgeR")
library("R.utils")
library("plyr")
library("limma")
library("Biobase")
library("GEOquery")
library("plyr")
#theme_set(theme_bw(base_size = 16))
library("biomaRt")
library("colorfulVennPlot")
library("VennDiagram")
library("gridExtra")
library("car")
library("topGO")
library("rowr")
library("Cormotif")
library("ggfortify")
library("dplyr")
library("tidyr")
library("statmod")
library("qtlcharts")
library("mygene")
source("~/Desktop/Endoderm_TC/ashlar-trial/analysis/chunk-options.R")


# Load the data 

cpm_cyclicloess_40 <- read.table("~/Desktop/Endoderm_TC/ashlar-trial/data/cpm_cyclicloess_40.txt")

# Setup matrix
mean_tech_reps_matrix <- as.matrix(cpm_cyclicloess_40, nrow=10304, ncol = 40)

mean_tech_reps_matrix[1:10304,1:40] = as.numeric(as.character(mean_tech_reps_matrix[1:10304,1:40]))
colnames(mean_tech_reps_matrix) <- colnames(cpm_cyclicloess_40)
rownames(mean_tech_reps_matrix) <- rownames(cpm_cyclicloess_40)

```


## Cormotif analysis


## Cormotif analysis (DE probabilities for consecutive days)

### Testing out different Ks

```{r, cormotif day diff}
# Create a factor for the experiments, with the levels ordered such that as.numeric converts them to numbers in a defined manner

# Note: there are 6 human biological replicates and 4 chimp biological replicates

species <- c("H", "H","H","H","H","H", "C", "C","C","C", 
             "H","H","H","H","H","H",  "C", "C","C","C",
             "H","H","H","H","H","H",  "C", "C","C","C",
             "H","H","H","H","H","H",  "C", "C","C","C")
day <- c("0", "0","0","0","0","0","0", "0", "0", "0", "1","1","1","1","1","1","1","1", "1","1",
         "2", "2","2","2","2","2","2","2","2", "2", 
         "3", "3","3","3","3","3","3","3",  "3", "3")

group_fac <- factor(paste(species, day, sep = "."),
                    levels = c("H.0", "H.1", "H.2", "H.3",
                               "C.0", "C.1", "C.2", "C.3"))
groupid <- as.numeric(group_fac)
# Conditions to compare:
# day0, day1, day2, day3, 

compid_tran <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                          c2 = c(2, 3, 4, 6, 7, 8))

                         
# Differences during diffentiation

set.seed(1)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 5:10, max.iter=500)

cormotif_tran$bestmotif$loglike

set.seed(12345)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 5:10, max.iter=500)

plotIC(cormotif_tran)
plotMotif(cormotif_tran)
cormotif_tran$bestmotif$loglike

set.seed(12345)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 7, max.iter=500)

plotIC(cormotif_tran)
plotMotif(cormotif_tran)
cormotif_tran$bestmotif$loglike

set.seed(12345)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 8, max.iter=500)

plotIC(cormotif_tran)
plotMotif(cormotif_tran)
cormotif_tran$bestmotif$loglike

gene_prob_tran <- cormotif_tran$bestmotif$p.post
rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)

# Seed 12345
prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3789

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] < 0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6 ]>0.5),])
length(prob_day_2)
#616

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_3)
#1024

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_4)
# 97

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#654

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_6)
#215

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_7)
#223

prob_day_8  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_8)
#1157
```

The seed number with the greatest log likelihood is seed # 66 for K = 8 and #4 for K = 7. It should be noted that the log likehood values are relatively similar. 

```{r}
# Re-run Cormotif with the best seed

compid_tran <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                          c2 = c(2, 3, 4, 6, 7, 8))


# Best seed when K = 7

set.seed(4)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 7, max.iter=500)

cormotif_tran$bestmotif$loglike
gene_prob_tran <- cormotif_tran$bestmotif$p.post

rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)

prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
write.table(prob_day_1, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_1_K7.txt")

#3795

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] > 0.5 & gene_prob_tran[,3] < 0.5 & gene_prob_tran[,4] < 0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6 ] < 0.5),])
length(prob_day_2)
write.table(prob_day_2, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_2_K7.txt")

#1144

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] < 0.5 & gene_prob_tran[,3] > 0.5 & gene_prob_tran[,4] < 0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_3)
write.table(prob_day_3, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_3_K7.txt")

#226

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.5 & gene_prob_tran[,2] > 0.5 & gene_prob_tran[,3] < 0.5 & gene_prob_tran[,4] > 0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6] < 0.5),])
length(prob_day_4)
write.table(prob_day_4, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_4_K7.txt")

# 680

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.5 & gene_prob_tran[,2] < 0.5 & gene_prob_tran[,3] < 0.5 & gene_prob_tran[,4] > 0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6] < 0.5),])
length(prob_day_5)
write.table(prob_day_5, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_5_K7.txt")

#1035

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] > 0.5 & gene_prob_tran[,3] > 0.5 & gene_prob_tran[,4] < 0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6] > 0.5),])
length(prob_day_6)
write.table(prob_day_6, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_6_K7.txt")

#618

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] > 0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_7)
write.table(prob_day_7, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_7_K7.txt")

#371


# Best seed when K = 8

set.seed(66)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 8, max.iter=500)

cormotif_tran$bestmotif$loglike
gene_prob_tran <- cormotif_tran$bestmotif$p.post
rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)


# Pull the genes from seed #66 when K = 8. 

prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3810
write.table(prob_day_1, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_1_K8.txt")

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_2)
#1130
write.table(prob_day_2, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_2_K8.txt")

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_3)
#217
write.table(prob_day_3, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_3_K8.txt")

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_4)
#164
write.table(prob_day_4, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_4_K8.txt")

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#673
write.table(prob_day_5, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_5_K8.txt")

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_6)
#1030
write.table(prob_day_6, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_6_K8.txt")

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_7)
#700
write.table(prob_day_7, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_7_K8.txt")

prob_day_8  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_8)
#334
write.table(prob_day_8, file="~/Desktop/Endoderm_TC/ashlar-trial/data/prob_cluster_8_K8.txt")
```


### Using the lowest likelihood seeds 
```{r}

# Lowest when K = 7

set.seed(54)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 7, max.iter=500)

cormotif_tran$bestmotif$loglike
gene_prob_tran <- cormotif_tran$bestmotif$p.post

rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)



prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3787

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_2)
#623

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_3)
#227

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_4)
#1154

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.5 & gene_prob_tran[,2] > 0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#324

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_6)
#464

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_7)
#1060


# Lowest when K = 8
set.seed(69)

cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 8, max.iter=500)


cormotif_tran$bestmotif$loglike
gene_prob_tran <- cormotif_tran$bestmotif$p.post

rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)



prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3787

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_2)
#328

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_3)
#622

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_4)
#1147

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] < 0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#227

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_6)
#170

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_7)
#1060

prob_day_8  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6] > 0.5),])
length(prob_day_8)
#473

```

## Cormotif analysis- supplement 

### DE probabilities all relative to day 0 rather than the previous day

```{r}
# The only thing we are changing is the compid_tran. Now, we are comparing everything to day 0 rather than the previous day

compid_tran <- data.frame(c1 = c(1, 1, 1, 5, 5, 5),
                          c2 = c(2, 3, 4, 6, 7, 8))

   

set.seed(66)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 8, max.iter=500)

cormotif_tran$bestmotif$loglike

gene_prob_tran <- cormotif_tran$bestmotif$p.post

rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)

# Pull the genes from seed #66 when K = 8. 


prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3446

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_2)
#188

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_3)
#249

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_4)
#602

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] < 0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#1897

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6] < 0.5),])
length(prob_day_6)
#449



prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_7)
#2078


```

### DE probabilities all relative to the previous day but using the data that was combined pre-normalization


```{r}
# Load the data 

cpm_cyclicloess_40 <- read.table("~/Desktop/Endoderm_TC/ashlar-trial/data/cpm_cyclicloess_40_pre_norm.txt")

# Setup matrix
mean_tech_reps_matrix <- as.matrix(cpm_cyclicloess_40, nrow=10304, ncol = 40)

mean_tech_reps_matrix[1:10304,1:40] = as.numeric(as.character(mean_tech_reps_matrix[1:10304,1:40]))
colnames(mean_tech_reps_matrix) <- colnames(cpm_cyclicloess_40)
rownames(mean_tech_reps_matrix) <- rownames(cpm_cyclicloess_40)

compid_tran <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                          c2 = c(2, 3, 4, 6, 7, 8))

set.seed(66)
cormotif_tran <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid,
                        compid = compid_tran, K = 8, max.iter=500)

cormotif_tran$bestmotif$loglike
gene_prob_tran <- cormotif_tran$bestmotif$p.post
rownames(gene_prob_tran) <- rownames( cpm_cyclicloess_40)
plotIC(cormotif_tran)
plotMotif(cormotif_tran)
dim(gene_prob_tran)


# Pull the genes from seed #66 when K = 8. 

prob_day_1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_1)
#3571

prob_day_2  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_2)
#710

prob_day_4  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] <0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_4)
#239

prob_day_5  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] <0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6]>0.5),])
length(prob_day_5)
#983

prob_day_6  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.5 & gene_prob_tran[,2] < 0.5 & gene_prob_tran[,3] <0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] < 0.5 & gene_prob_tran[,6]<0.5),])
length(prob_day_6)
#1043

prob_day_7  <- rownames(gene_prob_tran[(gene_prob_tran[,1] > 0.6 & gene_prob_tran[,2] > 0.6 & gene_prob_tran[,3] > 0.6 & gene_prob_tran[,4] > 0.6 & gene_prob_tran[,5] > 0.6 & gene_prob_tran[,6] > 0.6),])
length(prob_day_7)
#281

prob_day_3  <- rownames(gene_prob_tran[(gene_prob_tran[,1] >0.5 & gene_prob_tran[,2] >0.5 & gene_prob_tran[,3] >0.5 & gene_prob_tran[,4] >0.5 & gene_prob_tran[,5] > 0.5 & gene_prob_tran[,6] > 0.5),])
length(prob_day_3) - length(prob_day_7)
#113




```



### Identifying genes with interspecies differences by day (not used in the paper)

```{r, cormotif species diff}
# Create a factor for the experiments, with the levels ordered such that as.numeric converts them to numbers in a defined manner

# Note: there are 6 human biological replicates and 4 chimp biological replicates

species <- c("H", "H","H","H","H","H", "C", "C","C","C", 
             "H","H","H","H","H","H",  "C", "C","C","C",
             "H","H","H","H","H","H",  "C", "C","C","C",
             "H","H","H","H","H","H",  "C", "C","C","C")
day <- c("0", "0","0","0","0","0","0", "0", "0", "0", "1","1","1","1","1","1","1","1", "1","1",
         "2", "2","2","2","2","2","2","2","2", "2", 
         "3", "3","3","3","3","3","3","3",  "3", "3")

group_fac <- factor(paste(species, day, sep = "."),
                    levels = c( 
                               "H.0", "H.1", "H.2", "H.3", "C.0", "C.1", "C.2", "C.3"))
groupid <- as.numeric(group_fac)

# Conditions to compare:
# day0, day1, day2, day3, 
compid_day <- data.frame(c1 = c(1, 2, 3, 4),
                         c2 = c(5, 6, 7, 8))


#interspecies differences at each day
set.seed(12345)
cormotif_day <- cormotiffit(exprs = mean_tech_reps_matrix, groupid = groupid, compid = compid_day, K = 3:5)
plotIC(cormotif_day)
plotMotif(cormotif_day)

gene_prob_day <- cormotif_day$bestmotif$p.post
rownames(gene_prob_day) <- rownames(cpm_cyclicloess_40)


prob_sp_1 <- rownames(gene_prob_day[(gene_prob_day[,1] < 0.5 & gene_prob_day[,2] <0.5 & gene_prob_day[,3] <0.5 & gene_prob_day[,4] <0.5),])
length(prob_sp_1)
#4495

prob_sp_2 <- rownames(gene_prob_day[(gene_prob_day[,1] >0.7 & gene_prob_day[,2] >0.9 & gene_prob_day[,3] <0.5 & gene_prob_day[,4] <0.5),])
length(prob_sp_2)
#352

prob_sp_3 <- rownames(gene_prob_day[(gene_prob_day[,1] <0.5 & gene_prob_day[,2] <0.5 & gene_prob_day[,3] > 0.9 & gene_prob_day[,4] > 0.9),])
length(prob_sp_3)
#221

prob_sp_4 <- rownames(gene_prob_day[(gene_prob_day[,1] >0.9& gene_prob_day[,2] >0.9 & gene_prob_day[,3]>0.9 & gene_prob_day[,4] >0.9),])
length(prob_sp_4)
#2509

```


